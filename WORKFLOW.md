# FAMILY WALLET — WORKFLOW DOCUMENTATION

## DOMAIN MODEL

### Reward Purchase States

Статусы покупок наград:
- pending — Награда куплена ребёнком, ожидает выдачи родителем
- received — Награда получена ребёнком (подтверждено через кнопку "Получил")

Переходы:
- pending → received (ребёнок нажимает "Получил награду")

Правила:
- В UI детей отображаются только награды со статусом pending
- После перехода в received награда исчезает из списка
- Повторное нажатие "Получил" блокируется проверкой статуса

## API CONTRACTS

### POST /api/rewards/confirm-received

Описание: Подтверждение получения награды ребёнком

Заголовки:
- X-Invite-Code — детский invite-код

Побочные эффекты:
1. UPDATE reward_purchases SET status=received, received_at=NOW()
2. INSERT INTO events — запись события reward_received

Идемпотентность:
- SQL: WHERE status=pending — повторный запрос вернёт 404
- UI: Проверка статуса перед отправкой запроса

## UI BEHAVIOR

### Kids App — Награды

Вкладка "Я" (Мои награды):
- Отображаются только награды со статусом pending
- Кнопка "Получил награду" — без confirm(), без alert()
- После нажатия награда исчезает из списка

Вкладка "Магазин":
- Покупка награды — с confirm() (защита от случайных трат)
- После успешной покупки — без alert(), только обновление баланса

## VERSION HISTORY

### v0.12-rewards-stable (2026-01-05)
- Система подтверждения наград
- Запись событий в таблицу events
- Идемпотентность SQL и UI
- Убраны лишние алерты (оставлен только confirm при покупке)

### v0.11-events (2026-01-05)
- Создана таблица events для AI
- Реферальная система

## KNOWN ISSUES

TODO (приоритетные):
1. Мечты не отображаются у родителя — требуется диагностика
2. Счётчик "Получено наград: 0" не обновляется
3. Нужно добавить миссии для тестового ребёнка

Последнее обновление: 2026-01-05 02:25 MSK
