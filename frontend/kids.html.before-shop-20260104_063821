<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family Wallet ‚Äî –†–µ–±—ë–Ω–æ–∫</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    .section { margin: 30px 0; padding: 20px; border: 2px solid #ccc; }
    h1, h2 { margin-top: 0; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; font-size: 16px; }
    .task-item { padding: 15px; margin: 10px 0; border: 1px solid #ddd; background: #f9f9f9; }
    input { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
    .error { color: red; font-weight: bold; }
    .success { color: green; font-weight: bold; }
    .balance { font-size: 24px; font-weight: bold; margin: 20px 0; }
    .pending-dashboard { padding: 15px; margin: 10px 0; background: #fff4cc; border: 2px solid #ffcc00; font-size: 18px; font-weight: bold; }
    .status-IDLE { background: #f0f0f0; }
    .status-WAITING { background: #fff4cc; }
    .status-CONFIRMED { background: #d4edda; }
    .empty-state { text-align: center; padding: 40px; color: #999; font-size: 18px; }
    .history-item { padding: 10px; margin: 5px 0; background: #f9f9f9; border-left: 3px solid #4CAF50; }
  </style>
</head>
<body>
  <h1>üë∂ Family Wallet ‚Äî –†–µ–±—ë–Ω–æ–∫</h1>
  
  <div class="section">
    <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
    <input type="text" id="inviteCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Ä–µ–±—ë–Ω–∫–∞ (KID_STAS)" value="KID_STAS">
    <button onclick="login()">–í–æ–π—Ç–∏</button>
    <div id="authStatus"></div>
  </div>

  <div class="section" id="balanceSection" style="display:none;">
    <h2>–ú–æ–π –±–∞–ª–∞–Ω—Å</h2>
    <div class="balance" id="balanceDisplay"></div>
    <div id="pendingDashboard"></div>
  </div>

  <div class="section" id="tasksSection" style="display:none;">
    <h2>–ú–æ–∏ –º–∏—Å—Å–∏–∏</h2>
    <div id="tasksList"></div>
  </div>

  <div class="section" id="historySection" style="display:none;">
    <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
    <div id="historyList"></div>
  </div>

  <script>
    const API_URL = 'https://family-wallet-api.maltsevstas21.workers.dev';
    let currentCode = '';
    let childId = '';
    let childName = '';

    async function login() {
      const code = document.getElementById('inviteCode').value.trim();
      if (!code) {
        document.getElementById('authStatus').innerHTML = '<p class="error">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥</p>';
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/auth/whoami`, {
          headers: { 'X-Invite-Code': code }
        });

        if (!res.ok) {
          const err = await res.json();
          document.getElementById('authStatus').innerHTML = `<p class="error">–û—à–∏–±–∫–∞: ${err.error}</p>`;
          return;
        }

        const data = await res.json();
        
        if (data.role !== 'child') {
          document.getElementById('authStatus').innerHTML = '<p class="error">–≠—Ç–æ—Ç –∫–æ–¥ –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ—Ç—Å–∫–∏–π –∫–æ–¥.</p>';
          return;
        }

        currentCode = code;
        childId = data.child_id;
        childName = data.name;
        
        document.getElementById('authStatus').innerHTML = `<p class="success">‚úÖ –ü—Ä–∏–≤–µ—Ç, ${data.name}!</p>`;
        document.getElementById('balanceSection').style.display = 'block';
        document.getElementById('tasksSection').style.display = 'block';
        document.getElementById('historySection').style.display = 'block';

        updateBalance(data.balance, data.pending_balance);
        loadTasks();
        loadHistory();

      } catch (err) {
        document.getElementById('authStatus').innerHTML = `<p class="error">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${err.message}</p>`;
      }
    }

    function updateBalance(balance, pending) {
      document.getElementById('balanceDisplay').innerHTML = `${balance} ‚≠ê`;
      
      if (pending > 0) {
        document.getElementById('pendingDashboard').innerHTML = `
          <div class="pending-dashboard">
            ‚è≥ –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: ${pending} ‚≠ê
          </div>
        `;
      } else {
        document.getElementById('pendingDashboard').innerHTML = '';
      }
    }

    async function loadTasks() {
      try {
        const res = await fetch(`${API_URL}/api/tasks/list`, {
          headers: { 'X-Invite-Code': currentCode }
        });

        const data = await res.json();
        
        if (!Array.isArray(data.tasks)) {
          document.getElementById('tasksList').innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏—Å—Å–∏–π</p>';
          return;
        }

        const activeTasks = data.tasks.filter(t => t.status === 'IDLE' || t.status === 'WAITING' || t.status === 'REJECTED');

        if (activeTasks.length === 0) {
          document.getElementById('tasksList').innerHTML = '<div class="empty-state">üì≠ –ú–∏—Å—Å–∏–π –ø–æ–∫–∞ –Ω–µ—Ç<br><small>–û–±—Ä–∞—Ç–∏—Å—å –∫ —Ä–æ–¥–∏—Ç–µ–ª—é</small></div>';
          return;
        }

        document.getElementById('tasksList').innerHTML = activeTasks.map(task => {
          let buttonHtml = '';
          let statusText = '';

          if (task.status === 'IDLE' || task.status === 'REJECTED') {
            buttonHtml = `<button onclick="completeTask('${task.id}')">‚úÖ –Ø —ç—Ç–æ —Å–¥–µ–ª–∞–ª!</button>`;
            statusText = task.status === 'REJECTED' ? '<strong style="color: red;">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ ‚Äî –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑</strong>' : '';
          } else if (task.status === 'WAITING') {
            buttonHtml = '';
            statusText = '<strong style="color: orange;">‚è≥ –û–∂–∏–¥–∞–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è!</strong>';
          }

          return `
            <div class="task-item status-${task.status}">
              <strong>${task.icon || '‚úÖ'} ${task.title}</strong> ‚Äî ${task.reward_amount} ‚≠ê<br>
              ${task.description || ''}<br>
              ${statusText}
              ${buttonHtml}
            </div>
          `;
        }).join('');

      } catch (err) {
        document.getElementById('tasksList').innerHTML = `<p class="error">–û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }

    async function loadHistory() {
      try {
        const res = await fetch(`${API_URL}/api/tasks/list`, {
          headers: { 'X-Invite-Code': currentCode }
        });

        const data = await res.json();
        
        if (!Array.isArray(data.tasks)) {
          return;
        }

        const completedTasks = data.tasks.filter(t => t.status === 'CONFIRMED');

        if (completedTasks.length === 0) {
          document.getElementById('historyList').innerHTML = '<div class="empty-state">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
          return;
        }

        document.getElementById('historyList').innerHTML = completedTasks.map(task => `
          <div class="history-item">
            ‚úÖ ${task.title} ‚Äî +${task.reward_amount} ‚≠ê
          </div>
        `).join('');

      } catch (err) {
        document.getElementById('historyList').innerHTML = `<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</p>`;
      }
    }

    async function completeTask(taskId) {
      try {
        const res = await fetch(`${API_URL}/api/tasks/complete`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Invite-Code': currentCode
          },
          body: JSON.stringify({ task_id: taskId })
        });

        const data = await res.json();
        
        // –ë–µ–∑ alert ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI
        loadTasks();
        loadHistory();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
        const authRes = await fetch(`${API_URL}/api/auth/whoami`, {
          headers: { 'X-Invite-Code': currentCode }
        });
        const authData = await authRes.json();
        updateBalance(authData.balance, authData.pending_balance);

      } catch (err) {
        console.error('–û—à–∏–±–∫–∞:', err);
      }
    }

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    setInterval(() => {
      if (currentCode) {
        loadTasks();
        loadHistory();
        
        fetch(`${API_URL}/api/auth/whoami`, {
          headers: { 'X-Invite-Code': currentCode }
        })
        .then(r => r.json())
        .then(d => updateBalance(d.balance, d.pending_balance))
        .catch(() => {});
      }
    }, 5000);
  </script>
</body>
</html>
