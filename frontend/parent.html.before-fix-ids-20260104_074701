<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family Wallet ‚Äî –†–æ–¥–∏—Ç–µ–ª—å</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 0; margin: 0; max-width: 800px; margin: 0 auto; }
    .section { margin: 20px; padding: 20px; border: 2px solid #ccc; position: relative; }
    h1, h2 { margin-top: 0; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; font-size: 16px; }
    .task-item, .child-item { padding: 15px; margin: 10px 0; border: 1px solid #ddd; background: #f9f9f9; position: relative; }
    input, textarea, select { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
    .error { color: red; font-weight: bold; }
    .success { color: green; font-weight: bold; }
    .add-button { position: absolute; bottom: 80px; right: 20px; font-size: 32px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 50%; z-index: 1000; }
    .delete-button { position: absolute; top: 10px; right: 10px; background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    .form-popup { margin: 20px 0; padding: 15px; border: 2px dashed #999; background: #fafafa; display: none; }
    .invite-code-display { font-size: 18px; font-weight: bold; padding: 15px; background: #ffffcc; border: 2px solid #ffcc00; margin: 10px 0; }
    
    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
    .nav-tabs { display: flex; background: #333; margin: 0; padding: 0; }
    .nav-tabs button { flex: 1; padding: 15px; background: #333; color: white; border: none; cursor: pointer; font-size: 16px; }
    .nav-tabs button.active { background: #4CAF50; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .checkbox-group { margin: 10px 0; }
    .checkbox-group label { display: block; margin: 5px 0; }
    .empty-state { text-align: center; padding: 40px; color: #999; font-size: 18px; }
    .history-item { padding: 10px; margin: 5px 0; background: #f9f9f9; border-left: 3px solid #4CAF50; }

    .child-card { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .child-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

  </style>
</head>
<body>
  <h1 style="padding: 20px; margin: 0; background: #4CAF50; color: white;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Wallet ‚Äî –†–æ–¥–∏—Ç–µ–ª—å</h1>
  
  <div class="section">
    <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
    <input type="text" id="inviteCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è (SRFK4A1C)" value="SRFK4A1C">
    <button onclick="login()">–í–æ–π—Ç–∏</button>
    <div id="authStatus"></div>
  </div>

  <div id="mainApp" style="display:none;">
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="nav-tabs">
      <button class="active" onclick="showTab('tab-home')">–ì–ª–∞–≤–Ω–∞—è</button>
      <button onclick="showTab('tab-missions')">–ú–∏—Å—Å–∏–∏</button>
      <button onclick="showTab('tab-shop')">–ú–∞–≥–∞–∑–∏–Ω</button>
      <button onclick="showTab('tab-ai')">–ò–ò</button>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞: –ì–ª–∞–≤–Ω–∞—è -->
    <div id="tab-home" class="tab-content active">
      <div class="section">
        <h2>–ú–æ–∏ –¥–µ—Ç–∏</h2>
        <button class="add-button" onclick="toggleAddChildForm()" style="position: absolute; top: 20px; right: 20px; font-size: 24px; padding: 5px 15px; border-radius: 5px;">+</button>
        
        <div class="form-popup" id="addChildForm">
          <h3>–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞</h3>
          <input type="text" id="childName" placeholder="–ò–º—è">
          <input type="text" id="childRole" placeholder="–†–æ–ª—å (—Å—ã–Ω/–¥–æ—á—å/—Ä–µ–±—ë–Ω–æ–∫)">
          <input type="number" id="childAge" placeholder="–í–æ–∑—Ä–∞—Å—Ç">
          <button onclick="addChild()">–°–æ–∑–¥–∞—Ç—å</button>
          <button onclick="toggleAddChildForm()">–û—Ç–º–µ–Ω–∞</button>
          <div id="addChildStatus"></div>
        </div>
        
        <div id="childrenList"></div>

      <!-- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–±—ë–Ω–∫–∞ -->
      <div id="childPersonalView" style="display:none;">
        <button onclick="backToChildrenList()" style="margin-bottom: 20px;">
          ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –¥–µ—Ç–µ–π
        </button>
        
        <div id="childPersonalHeader"></div>
        
        <div class="section">
          <h2>üéØ –ú–∏—Å—Å–∏–∏</h2>
          <div id="childPersonalTasks"></div>
        </div>
        
        <div class="section">
          <h2>üéÅ –ö—É–ø–ª–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã</h2>
          <div id="childPersonalRewards"></div>
        </div>
      </div>

      </div>

      <div class="section">
        <h2>–ó–∞–¥–∞—á–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</h2>
        <div id="pendingTasks"></div>
      </div>
    </div>


      <div class="section">
        <h2>üéÅ –ö—É–ø–ª–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –¥–µ—Ç–µ–π</h2>
        <div id="rewardPurchasesDashboard"></div>
      </div>
      <div class="section">
        <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
        <div id="historyList"></div>
      </div>

    <!-- –í–∫–ª–∞–¥–∫–∞: –ú–∏—Å—Å–∏–∏ -->
    <div id="tab-missions" class="tab-content">
      <div class="section" style="min-height: 400px; position: relative;">
        <h2>–ú–∏—Å—Å–∏–∏</h2>
        <button class="add-button" onclick="toggleAddTaskForm()">+</button>
        
        <div class="form-popup" id="addTaskForm">
          <h3>–°–æ–∑–¥–∞—Ç—å –º–∏—Å—Å–∏—é</h3>
          <input type="text" id="taskTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∏—Å—Å–∏–∏*">
          <textarea id="taskDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" rows="3"></textarea>
          <input type="number" id="taskReward" placeholder="–°—É–º–º–∞ (FAM)*">
          
          <div class="checkbox-group">
            <label>
              <input type="checkbox" id="taskRecurring" onchange="toggleRecurringOptions()">
              –ü–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è
            </label>
          </div>
          
          <div id="recurringOptions" style="display:none; margin-left: 20px;">
            <select id="recurringType" onchange="toggleDaysSelection()">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
              <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è</option>
              <option value="weekends">–ü–æ –≤—ã—Ö–æ–¥–Ω—ã–º</option>
              <option value="custom">–í—ã–±—Ä–∞—Ç—å –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏</option>
            </select>
            
            <div id="daysSelection" style="display:none; margin-top: 10px;">
              <label><input type="checkbox" value="1"> –ü–Ω</label>
              <label><input type="checkbox" value="2"> –í—Ç</label>
              <label><input type="checkbox" value="3"> –°—Ä</label>
              <label><input type="checkbox" value="4"> –ß—Ç</label>
              <label><input type="checkbox" value="5"> –ü—Ç</label>
              <label><input type="checkbox" value="6"> –°–±</label>
              <label><input type="checkbox" value="0"> –í—Å</label>
            </div>
          </div>
          
          <div class="checkbox-group">
            <h4>–î–ª—è –∫–æ–≥–æ –º–∏—Å—Å–∏—è:</h4>
            <div id="taskChildrenSelection"></div>
          </div>
          
          <button onclick="createTask()">–°–æ–∑–¥–∞—Ç—å –º–∏—Å—Å–∏—é</button>
          <button onclick="toggleAddTaskForm()">–û—Ç–º–µ–Ω–∞</button>
          <div id="addTaskStatus"></div>
        </div>
        
        <div id="tasksList"></div>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞: –ú–∞–≥–∞–∑–∏–Ω -->
    <div id="tab-shop" class="tab-content">
      <div class="section" style="min-height: 400px; position: relative;">
        <h2>–ú–∞–≥–∞–∑–∏–Ω –Ω–∞–≥—Ä–∞–¥</h2>
        <button class="add-button" onclick="toggleAddRewardForm()">+</button>
        
        <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã -->
        <div class="form-popup" id="addRewardForm">
          <input type="text" id="rewardTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã" />
          <textarea id="rewardDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã" rows="3"></textarea>
          <input type="number" id="rewardPrice" placeholder="–¶–µ–Ω–∞ (1-10000)" min="1" max="10000" />
          <label style="display: flex; align-items: center; gap: 8px; margin: 10px 0;">
            <input type="checkbox" id="rewardIsPermanent" />
            <span>–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Å–ª–æ—Ç (–æ—Å—Ç–∞—ë—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏)</span>
          </label>
          <button onclick="createReward()">–°–æ–∑–¥–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É</button>
          <button onclick="toggleAddRewardForm()">–û—Ç–º–µ–Ω–∞</button>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –Ω–∞–≥—Ä–∞–¥ -->
        <div id="rewardsList"></div>
      </div>
    </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞: –ò–ò -->
    <div id="tab-ai" class="tab-content">
      <div class="section">
        <h2>–ò–ò-—Å–æ–≤–µ—Ç—ã</h2>
        <p>–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è AI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –¥–µ—Ç—è–º...</p>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://family-wallet-api.maltsevstas21.workers.dev';
    let currentCode = '';
    let familyId = '';
    let childrenData = [];

    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.nav-tabs button').forEach(btn => btn.classList.remove('active'));
      
      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active');
      
      if (tabId === 'tab-missions') {
        loadAllTasks();
      }
    }

    function toggleRecurringOptions() {
      const isChecked = document.getElementById('taskRecurring').checked;
      document.getElementById('recurringOptions').style.display = isChecked ? 'block' : 'none';
    }

    function toggleDaysSelection() {
      const type = document.getElementById('recurringType').value;
      document.getElementById('daysSelection').style.display = type === 'custom' ? 'block' : 'none';
    }

    function toggleAddChildForm() {
      const form = document.getElementById('addChildForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      if (form.style.display === 'block') {
        document.getElementById('childName').value = '';
        document.getElementById('childRole').value = '';
        document.getElementById('childAge').value = '';
        document.getElementById('addChildStatus').innerHTML = '';
      }
    }

    function toggleAddTaskForm() {
      const form = document.getElementById('addTaskForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      if (form.style.display === 'block') {
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskDescription').value = '';
        document.getElementById('taskReward').value = '';
        document.getElementById('taskRecurring').checked = false;
        document.getElementById('addTaskStatus').innerHTML = '';
        toggleRecurringOptions();
        updateChildrenSelection();
      }
    }

    function updateChildrenSelection() {
      const container = document.getElementById('taskChildrenSelection');
      if (childrenData.length === 0) {
        container.innerHTML = '<p class="error">–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –¥–µ—Ç–µ–π</p>';
        return;
      }
      
      container.innerHTML = childrenData.map(child => `
        <label>
          <input type="checkbox" class="child-checkbox" value="${child.id}">
          ${child.name} (${child.role}, ${child.age} –ª–µ—Ç)
        </label>
      `).join('');
    }

    async function createTask() {
      const title = document.getElementById('taskTitle').value.trim();
      const description = document.getElementById('taskDescription').value.trim();
      const reward = document.getElementById('taskReward').value.trim();
      const isRecurring = document.getElementById('taskRecurring').checked;
      
      if (!title || !reward) {
        document.getElementById('addTaskStatus').innerHTML = '<p class="error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—É–º–º–∞)</p>';
        return;
      }

      const selectedChildren = Array.from(document.querySelectorAll('.child-checkbox:checked')).map(cb => cb.value);
      
      if (selectedChildren.length === 0) {
        document.getElementById('addTaskStatus').innerHTML = '<p class="error">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞</p>';
        return;
      }

      let recurring = null;
      let recurringDays = null;

      if (isRecurring) {
        const recurringType = document.getElementById('recurringType').value;
        if (!recurringType) {
          document.getElementById('addTaskStatus').innerHTML = '<p class="error">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</p>';
          return;
        }

        if (recurringType === 'daily') {
          recurring = 'daily';
        } else if (recurringType === 'weekends') {
          recurring = 'weekends';
        } else if (recurringType === 'custom') {
          const selectedDays = Array.from(document.querySelectorAll('#daysSelection input:checked')).map(cb => cb.value);
          if (selectedDays.length === 0) {
            document.getElementById('addTaskStatus').innerHTML = '<p class="error">–í—ã–±–µ—Ä–∏—Ç–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏</p>';
            return;
          }
          recurring = 'custom';
          recurringDays = JSON.stringify(selectedDays);
        }
      }

      try {
        // –°–æ–∑–¥–∞—ë–º –∑–∞–¥–∞—á—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞
        for (const childId of selectedChildren) {
          const res = await fetch(`${API_URL}/api/tasks/create`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Invite-Code': currentCode
            },
            body: JSON.stringify({
              child_id: childId,
              title,
              description,
              reward_amount: parseInt(reward),
              recurring,
              recurring_days: recurringDays
            })
          });

          const data = await res.json();
          if (!res.ok) {
            document.getElementById('addTaskStatus').innerHTML = `<p class="error">–û—à–∏–±–∫–∞: ${data.error}</p>`;
            return;
          }
        }

        document.getElementById('addTaskStatus').innerHTML = '<p class="success">‚úÖ –ú–∏—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞!</p>';
        setTimeout(() => {
          toggleAddTaskForm();
          loadAllTasks();
        }, 1500);

      } catch (err) {
        document.getElementById('addTaskStatus').innerHTML = `<p class="error">–û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }

    async function loadAllTasks() {
      try {
        const res = await fetch(`${API_URL}/api/tasks/list`, {
          headers: { 'X-Invite-Code': currentCode }
        });

        const data = await res.json();
        
        if (!Array.isArray(data.tasks)) {
          document.getElementById('tasksList').innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á</p>';
          return;
        }

        if (data.tasks.length === 0) {
          document.getElementById('tasksList').innerHTML = '<p>–ú–∏—Å—Å–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞–∂–º–∏—Ç–µ "+" —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å.</p>';
          return;
        }

        document.getElementById('tasksList').innerHTML = data.tasks.map(task => `
          <div class="task-item">
            <button class="delete-button" onclick="deleteTask('${task.id}')">‚úï</button>
            <strong>${task.title}</strong> ‚Äî ${task.reward_amount} ‚≠ê<br>
            ${task.description || ''}<br>
            <small>–°—Ç–∞—Ç—É—Å: ${task.status} ${task.recurring ? '(–ø–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è: ' + task.recurring + ')' : ''}</small>
            ${task.status === 'WAITING' ? '<br><button onclick="confirmTask(\''+task.id+'\', \'confirm\')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button> <button onclick="confirmTask(\''+task.id+'\', \'reject\')">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>' : ''}
          </div>
        `).join('');

      } catch (err) {
        document.getElementById('tasksList').innerHTML = `<p class="error">–û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }

    async function deleteTask(taskId) {
      

      try {
        const res = await fetch(`${API_URL}/api/tasks/delete`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'X-Invite-Code': currentCode
          },
          body: JSON.stringify({ task_id: taskId })
        });

        const data = await res.json();
        
        if (!res.ok) {
          alert('–û—à–∏–±–∫–∞: ' + data.error);
          return;
        }

        loadAllTasks();

      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    async function addChild() {
      const name = document.getElementById('childName').value.trim();
      const role = document.getElementById('childRole').value.trim();
      const age = document.getElementById('childAge').value.trim();

      if (!name || !role || !age) {
        document.getElementById('addChildStatus').innerHTML = '<p class="error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è</p>';
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/children/add`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Invite-Code': currentCode
          },
          body: JSON.stringify({ name, role, age: parseInt(age) })
        });

        const data = await res.json();

        if (!res.ok) {
          document.getElementById('addChildStatus').innerHTML = `<p class="error">–û—à–∏–±–∫–∞: ${data.error}</p>`;
          return;
        }

        document.getElementById('addChildStatus').innerHTML = `
          <p class="success">‚úÖ ${data.message}</p>
          <div class="invite-code-display">
            –ö–û–î –†–ï–ë–Å–ù–ö–ê: ${data.child.invite_code}
            <br><button onclick="copyToClipboard('${data.child.invite_code}')">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <p><strong>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ —Ä–µ–±—ë–Ω–∫—É –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –¥–µ—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</strong></p>
        `;

        loadChildren();

        document.getElementById('childName').value = '';
        document.getElementById('childRole').value = '';
        document.getElementById('childAge').value = '';

      } catch (err) {
        document.getElementById('addChildStatus').innerHTML = `<p class="error">–û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
      }).catch(() => {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ü–µ—Ä–µ–ø–∏—à–∏—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é.');
      });
    }
    async function loadHistory() {
      try {
        const res = await fetch(`${API_URL}/api/tasks/list`, {
          headers: { 'X-Invite-Code': currentCode }
        });
        const data = await res.json();
        if (!Array.isArray(data.tasks)) return;
        const completed = data.tasks.filter(t => t.status === 'CONFIRMED').slice(0, 10);
        if (completed.length === 0) {
          document.getElementById('historyList').innerHTML = '<div class="empty-state">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
          return;
        }
        document.getElementById('historyList').innerHTML = completed.map(task => `
          <div class="history-item">‚úÖ ${task.title} ‚Äî +${task.reward_amount} ‚≠ê</div>
        `).join('');
      } catch (err) {
        document.getElementById('historyList').innerHTML = `<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</p>`;
      }
    }



    async function login() {
      const code = document.getElementById('inviteCode').value.trim();
      if (!code) {
        document.getElementById('authStatus').innerHTML = '<p class="error">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</p>';
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/auth/whoami`, {
          headers: { 'X-Invite-Code': code }
        });

        if (!res.ok) {
          const err = await res.json();
          document.getElementById('authStatus').innerHTML = `<p class="error">–û—à–∏–±–∫–∞: ${err.error}</p>`;
          return;
        }

        const data = await res.json();
        
        if (data.role !== 'parent') {
          document.getElementById('authStatus').innerHTML = '<p class="error">–≠—Ç–æ—Ç –∫–æ–¥ –¥–ª—è —Ä–µ–±—ë–Ω–∫–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–¥.</p>';
          return;
        }

        currentCode = code;
        familyId = data.family_id;
        
        document.getElementById('authStatus').innerHTML = `<p class="success">‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${data.family_name}!</p>`;
        document.getElementById('mainApp').style.display = 'block';

        loadChildren();
        loadPendingTasks();
        loadPendingRewardPurchases();
        loadHistory();

      } catch (err) {
        document.getElementById('authStatus').innerHTML = `<p class="error">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${err.message}</p>`;
      }
    }

    async function loadChildren() {
      try {
        const res = await fetch(`${API_URL}/api/children/list`, {
          headers: { 'X-Invite-Code': currentCode }
        });

        const data = await res.json();
        
        if (!Array.isArray(data.children)) {
          document.getElementById('childrenList').innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–µ–π</p>';
          return;
        }

        childrenData = data.children;

        if (data.children.length === 0) {
          document.getElementById('childrenList').innerHTML = '<p>–î–µ—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞–∂–º–∏—Ç–µ "+" —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.</p>';
          return;
        }

        document.getElementById('childrenList').innerHTML = data.children.map(child => `
          <div class="child-item child-card" onclick="showChildPersonalView(\'${child.id}')">
            <strong>${child.name}</strong> (${child.role}, ${child.age} –ª–µ—Ç)<br>
            –ë–∞–ª–∞–Ω—Å: ${child.balance} ‚≠ê | –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ: ${child.pending_balance} ‚≠ê<br>
            –ö–æ–¥ —Ä–µ–±—ë–Ω–∫–∞: <code>${child.invite_code}</code>
          </div>
        `).join('');

      } catch (err) {
        document.getElementById('childrenList').innerHTML = `<p class="error">–û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }


    // ============================
    // –ü–ï–†–°–û–ù–ê–õ–¨–ù–ê–Ø –°–¢–†–ê–ù–ò–¶–ê –†–ï–ë–Å–ù–ö–ê
    // ============================
    
    let selectedChildId = null;

    function showChildPersonalView(childId) {
      selectedChildId = childId;
      
      // –°–∫—Ä—ã–≤–∞–µ–º –æ–±—â–∏–π view
      document.getElementById('childrenList').style.display = 'none';
      document.getElementById('pendingTasksSection').style.display = 'none';
      document.getElementById('rewardPurchasesDashboard').style.display = 'none';
      document.getElementById('historySection').style.display = 'none';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π view
      document.getElementById('childPersonalView').style.display = 'block';
      
      loadChildPersonalData(childId);
    }

    function backToChildrenList() {
      selectedChildId = null;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–∏–π view
      document.getElementById('childrenList').style.display = 'block';
      document.getElementById('pendingTasksSection').style.display = 'block';
      document.getElementById('rewardPurchasesDashboard').style.display = 'block';
      document.getElementById('historySection').style.display = 'block';
      
      // –°–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π view
      document.getElementById('childPersonalView').style.display = 'none';
    }

    async function loadChildPersonalData(childId) {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–±—ë–Ω–∫–∞
        const childRes = await fetch(`${API_URL}/api/children/${childId}`, {
          headers: { 'X-Invite-Code': currentCode }
        });
        
        if (!childRes.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–±—ë–Ω–∫–∞');
        
        const childData = await childRes.json();
        const child = childData.child;
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        document.getElementById('childPersonalHeader').innerHTML = `
          <div style="padding: 20px; background: #f0f0f0; border-radius: 8px; margin-bottom: 20px;">
            <h2>${child.name} (${child.role}, ${child.age} –ª–µ—Ç)</h2>
            <div style="font-size: 24px; font-weight: bold; margin-top: 10px;">
              –ë–∞–ª–∞–Ω—Å: ${child.balance} ‚≠ê | –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ: ${child.pending_balance} ‚≠ê
            </div>
            <div style="color: #666; margin-top: 5px;">
              –ö–æ–¥ —Ä–µ–±—ë–Ω–∫–∞: ${child.invite_code}
            </div>
          </div>
        `;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∏—Å—Å–∏–∏ —Ä–µ–±—ë–Ω–∫–∞
        await loadChildPersonalTasks(childId);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–≥—Ä–∞–¥—ã —Ä–µ–±—ë–Ω–∫–∞
        await loadChildPersonalRewards(childId);
        
      } catch (err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
        backToChildrenList();
      }
    }

    async function loadChildPersonalTasks(childId) {
      try {
        const res = await fetch(`${API_URL}/api/tasks/list`, {
          headers: { 'X-Invite-Code': currentCode }
        });
        
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏—Å—Å–∏–π');
        
        const data = await res.json();
        const childTasks = (data.tasks || []).filter(t => t.child_id === childId && t.status !== 'ARCHIVED');
        
        const list = document.getElementById('childPersonalTasks');
        
        if (childTasks.length === 0) {
          list.innerHTML = '<div class="empty-state">–ù–µ—Ç –º–∏—Å—Å–∏–π</div>';
          return;
        }
        
        const idleTasks = childTasks.filter(t => t.status === 'IDLE');
        const waitingTasks = childTasks.filter(t => t.status === 'WAITING');
        
        let html = '';
        
        if (idleTasks.length > 0) {
          html += '<h3>üìã –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –º–∏—Å—Å–∏–∏</h3>';
          html += idleTasks.map(t => `
            <div class="task-item status-${t.status}">
              <span style="font-size: 24px; margin-right: 10px;">${t.icon}</span>
              <strong>${t.title}</strong><br>
              ${t.description || ''}<br>
              –ù–∞–≥—Ä–∞–¥–∞: <strong>${t.reward_amount} ‚≠ê</strong>
            </div>
          `).join('');
        }
        
        if (waitingTasks.length > 0) {
          html += '<h3 style="margin-top: 20px;">‚è≥ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</h3>';
          html += waitingTasks.map(t => `
            <div class="task-item status-${t.status}">
              <span style="font-size: 24px; margin-right: 10px;">${t.icon}</span>
              <strong>${t.title}</strong><br>
              ${t.description || ''}<br>
              –ù–∞–≥—Ä–∞–¥–∞: <strong>${t.reward_amount} ‚≠ê</strong><br>
              <button onclick="handleTaskAction('${t.id}', 'confirm')" style="background: #4CAF50; color: white; margin-top: 10px;">
                ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
              </button>
              <button onclick="handleTaskAction('${t.id}', 'reject')" style="background: #f44336; color: white; margin-top: 10px;">
                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
              </button>
            </div>
          `).join('');
        }
        
        list.innerHTML = html;
        
      } catch (err) {
        document.getElementById('childPersonalTasks').innerHTML = 
          `<p class="error">–û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }

    async function loadChildPersonalRewards(childId) {
      try {
        const res = await fetch(`${API_URL}/api/rewards/purchases`, {
          headers: { 'X-Invite-Code': currentCode }
        });
        
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–≥—Ä–∞–¥');
        
        const data = await res.json();
        const childRewards = (data.purchases || []).filter(p => p.child_id === childId && p.status === 'pending');
        
        const list = document.getElementById('childPersonalRewards');
        
        if (childRewards.length === 0) {
          list.innerHTML = '<div class="empty-state">–ù–µ—Ç –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥</div>';
          return;
        }
        
        list.innerHTML = childRewards.map(p => `
          <div style="padding: 15px; margin: 10px 0; border: 2px solid #FF9800; background: #fff8e1; border-radius: 8px;">
            <span style="font-size: 32px; margin-right: 10px;">${p.reward_icon}</span>
            <strong>${p.reward_title}</strong> –∑–∞ <strong>${p.price} ‚≠ê</strong>
            <div style="color: #666; font-size: 14px; margin-top: 5px;">
              ${new Date(p.purchased_at).toLocaleString('ru-RU')}
            </div>
            <div style="color: #FF9800; font-weight: bold; margin-top: 5px;">
              ‚è≥ –û–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏
            </div>
          </div>
        `).join('');
        
      } catch (err) {
        document.getElementById('childPersonalRewards').innerHTML = 
          `<p class="error">–û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }


    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥ –¥–µ—Ç–µ–π
    async function loadPendingRewardPurchases() {
      try {
        const res = await fetch(`${API_URL}/api/rewards/purchases/family`, {
          headers: { 'X-Invite-Code': currentCode }
        });
        
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫');
        
        const data = await res.json();
        const dashboard = document.getElementById('rewardPurchasesDashboard');
        
        if (!data.purchases || data.purchases.length === 0) {
          dashboard.innerHTML = '';
          return;
        }
        
        const html = `
          <div style="margin: 20px 0;">
            <h3>üéÅ –ö—É–ø–ª–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –¥–µ—Ç–µ–π</h3>
            ${data.purchases.map(p => `
              <div style="padding: 15px; margin: 10px 0; border: 2px solid #FF9800; background: #fff8e1; border-radius: 8px;">
                <span style="font-size: 32px; margin-right: 10px;">${p.reward_icon}</span>
                <strong>${p.child_name}</strong> –∫—É–ø–∏–ª(–∞):
                <strong>${p.reward_title}</strong> –∑–∞ <strong>${p.price} ‚≠ê</strong>
                <div style="color: #666; font-size: 14px; margin-top: 5px;">
                  ${new Date(p.purchased_at).toLocaleString('ru-RU')}
                </div>
                <div style="color: #FF9800; font-weight: bold; margin-top: 5px;">
                  ‚è≥ –û–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏
                </div>
              </div>
            `).join('')}
          </div>
        `;
        
        dashboard.innerHTML = html;
        
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫:', err);
      }
    }

    async function loadPendingTasks() {
      try {
        const res = await fetch(`${API_URL}/api/tasks/list`, {
          headers: { 'X-Invite-Code': currentCode }
        });

        const data = await res.json();
        
        if (!Array.isArray(data.tasks)) {
          document.getElementById('pendingTasks').innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á</p>';
          return;
        }

        const pending = data.tasks.filter(t => t.status === 'WAITING');

        if (pending.length === 0) {
          document.getElementById('pendingTasks').innerHTML = '<p>–ù–µ—Ç –∑–∞–¥–∞—á –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</p>';
          return;
        }

        document.getElementById('pendingTasks').innerHTML = pending.map(task => `
          <div class="task-item">
            <strong>${task.title}</strong> ‚Äî ${task.reward_amount} ‚≠ê<br>
            ${task.description || ''}<br>
            <button onclick="confirmTask('${task.id}', 'confirm')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <button onclick="confirmTask('${task.id}', 'reject')">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
          </div>
        `).join('');



      } catch (err) {
        document.getElementById('pendingTasks').innerHTML = `<p class="error">–û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }

    async function confirmTask(taskId, action) {
      try {
        const res = await fetch(`${API_URL}/api/tasks/confirm`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Invite-Code': currentCode
          },
          body: JSON.stringify({ task_id: taskId, action })
        });

        const data = await res.json();
        
        
        loadPendingTasks();
        loadPendingRewardPurchases();
        loadHistory();
        loadChildren();

      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    setInterval(() => {
      if (currentCode) {
        loadPendingTasks();
        loadPendingRewardPurchases();
        loadHistory();
        loadChildren();
      }
    }, 5000);

    // ============================
    // –ú–ê–ì–ê–ó–ò–ù –ù–ê–ì–†–ê–î
    // ============================

    function toggleAddRewardForm() {
      const form = document.getElementById('addRewardForm');
      form.style.display = form.style.display === 'block' ? 'none' : 'block';
      if (form.style.display === 'block') {
        document.getElementById('rewardTitle').value = '';
        document.getElementById('rewardDescription').value = '';
        document.getElementById('rewardPrice').value = '';
        document.getElementById('rewardIsPermanent').checked = false;
      }
    }

    async function loadRewards() {
      try {
        const res = await fetch(`${API_URL}/api/rewards/list`, {
          headers: { 'X-Invite-Code': currentCode }
        });
        const data = await res.json();
        if (!Array.isArray(data.rewards)) {
          document.getElementById('rewardsList').innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–≥—Ä–∞–¥</p>';
          return;
        }
        const rewardsList = document.getElementById('rewardsList');
        if (data.rewards.length === 0) {
          rewardsList.innerHTML = '<div class="empty-state">–ù–∞–≥—Ä–∞–¥ –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞–∂–º–∏—Ç–µ \'+\' —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.</div>';
          return;
        }
        rewardsList.innerHTML = data.rewards.map(reward => `
          <div class="task-item" style="position: relative;">
            <button class="delete-button" onclick="deleteReward('${reward.id}')">‚úï</button>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 32px;">${reward.icon || 'üéÅ'}</span>
              <div style="flex: 1;">
                <strong>${reward.title}</strong>
                <div style="font-size: 14px; color: #666;">${reward.description || ''}</div>
                <div style="margin-top: 5px;">
                  <span style="font-weight: bold; color: #4CAF50;">${reward.price} ‚≠ê</span>
                  ${reward.is_permanent ? '<span style="margin-left: 10px; font-size: 12px; color: #999;">üìå –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π</span>' : '<span style="margin-left: 10px; font-size: 12px; color: #999;">üîÑ –†–∞–∑–æ–≤—ã–π</span>'}
                </div>
              </div>
            </div>
          </div>
        `).join('');
      } catch (err) {
        document.getElementById('rewardsList').innerHTML = `<p class="error">–û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }

    async function createReward() {
      const title = document.getElementById('rewardTitle').value.trim();
      const description = document.getElementById('rewardDescription').value.trim();
      const price = parseInt(document.getElementById('rewardPrice').value);
      const isPermanent = document.getElementById('rewardIsPermanent').checked;
      if (!title) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã');
        return;
      }
      if (!price || price < 1 || price > 10000) {
        alert('–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 1 –¥–æ 10000');
        return;
      }
      try {
        const res = await fetch(`${API_URL}/api/rewards/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Invite-Code': currentCode
          },
          body: JSON.stringify({ title, description, price, is_permanent: isPermanent })
        });
        const data = await res.json();
        if (data.error) {
          alert('–û—à–∏–±–∫–∞: ' + data.error);
          return;
        }
        toggleAddRewardForm();
        loadRewards();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã: ' + err.message);
      }
    }

    async function deleteReward(rewardId) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –Ω–∞–≥—Ä–∞–¥—É?')) return;
      try {
        const res = await fetch(`${API_URL}/api/rewards/delete`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'X-Invite-Code': currentCode
          },
          body: JSON.stringify({ reward_id: rewardId })
        });
        const data = await res.json();
        if (data.error) {
          alert('–û—à–∏–±–∫–∞: ' + data.error);
          return;
        }
        loadRewards();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã: ' + err.message);
      }
    }

  </script>
</body>
</html>
