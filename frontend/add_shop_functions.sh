#!/bin/bash

WORKER_FILE="parent.html"

# –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É </script> –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –ü–ï–†–ï–î –Ω–µ–π
awk '
/<\/script>/ && !done {
  print ""
  print "    // ============================"
  print "    // –ú–ê–ì–ê–ó–ò–ù –ù–ê–ì–†–ê–î"
  print "    // ============================"
  print ""
  print "    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã"
  print "    function toggleAddRewardForm() {"
  print "      const form = document.getElementById(\"addRewardForm\");"
  print "      form.style.display = form.style.display === \"block\" ? \"none\" : \"block\";"
  print "      "
  print "      // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏"
  print "      if (form.style.display === \"block\") {"
  print "        document.getElementById(\"rewardTitle\").value = \"\";"
  print "        document.getElementById(\"rewardDescription\").value = \"\";"
  print "        document.getElementById(\"rewardPrice\").value = \"\";"
  print "        document.getElementById(\"rewardIsPermanent\").checked = false;"
  print "      }"
  print "    }"
  print ""
  print "    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –Ω–∞–≥—Ä–∞–¥"
  print "    async function loadRewards() {"
  print "      try {"
  print "        const res = await fetch(`${API_URL}/api/rewards/list`, {"
  print "          headers: { \"X-Invite-Code\": currentCode }"
  print "        });"
  print ""
  print "        const data = await res.json();"
  print "        "
  print "        if (!Array.isArray(data.rewards)) {"
  print "          document.getElementById(\"rewardsList\").innerHTML = \"<p class=\\\"error\\\">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–≥—Ä–∞–¥</p>\";"
  print "          return;"
  print "        }"
  print ""
  print "        const rewardsList = document.getElementById(\"rewardsList\");"
  print "        "
  print "        if (data.rewards.length === 0) {"
  print "          rewardsList.innerHTML = \"<div class=\\\"empty-state\\\">–ù–∞–≥—Ä–∞–¥ –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞–∂–º–∏—Ç–µ \\'+\\' —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.</div>\";"
  print "          return;"
  print "        }"
  print ""
  print "        rewardsList.innerHTML = data.rewards.map(reward => `"
  print "          <div class=\\\"task-item\\\" style=\\\"position: relative;\\\">"
  print "            <button class=\\\"delete-button\\\" onclick=\\\"deleteReward(\\'${reward.id}\\')\\\">‚úï</button>"
  print "            <div style=\\\"display: flex; align-items: center; gap: 10px;\\\">"
  print "              <span style=\\\"font-size: 32px;\\\">${reward.icon || \"üéÅ\"}</span>"
  print "              <div style=\\\"flex: 1;\\\">"
  print "                <strong>${reward.title}</strong>"
  print "                <div style=\\\"font-size: 14px; color: #666;\\\">${reward.description || \"\"}</div>"
  print "                <div style=\\\"margin-top: 5px;\\\">"
  print "                  <span style=\\\"font-weight: bold; color: #4CAF50;\\\">${reward.price} ‚≠ê</span>"
  print "                  ${reward.is_permanent ? \"<span style=\\\"margin-left: 10px; font-size: 12px; color: #999;\\\">üìå –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π</span>\" : \"<span style=\\\"margin-left: 10px; font-size: 12px; color: #999;\\\">üîÑ –†–∞–∑–æ–≤—ã–π</span>\"}"
  print "                </div>"
  print "              </div>"
  print "            </div>"
  print "          </div>"
  print "        `).join(\"\");"
  print ""
  print "      } catch (err) {"
  print "        document.getElementById(\"rewardsList\").innerHTML = `<p class=\\\"error\\\">–û—à–∏–±–∫–∞: ${err.message}</p>`;"
  print "      }"
  print "    }"
  print ""
  print "    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –Ω–∞–≥—Ä–∞–¥—ã"
  print "    async function createReward() {"
  print "      const title = document.getElementById(\"rewardTitle\").value.trim();"
  print "      const description = document.getElementById(\"rewardDescription\").value.trim();"
  print "      const price = parseInt(document.getElementById(\"rewardPrice\").value);"
  print "      const isPermanent = document.getElementById(\"rewardIsPermanent\").checked;"
  print ""
  print "      // –í–∞–ª–∏–¥–∞—Ü–∏—è"
  print "      if (!title) {"
  print "        alert(\"–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã\");"
  print "        return;"
  print "      }"
  print ""
  print "      if (!price || price < 1 || price > 10000) {"
  print "        alert(\"–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 1 –¥–æ 10000\");"
  print "        return;"
  print "      }"
  print ""
  print "      try {"
  print "        const res = await fetch(`${API_URL}/api/rewards/create`, {"
  print "          method: \"POST\","
  print "          headers: {"
  print "            \"Content-Type\": \"application/json\","
  print "            \"X-Invite-Code\": currentCode"
  print "          },"
  print "          body: JSON.stringify({ title, description, price, is_permanent: isPermanent })"
  print "        });"
  print ""
  print "        const data = await res.json();"
  print "        "
  print "        if (data.error) {"
  print "          alert(\"–û—à–∏–±–∫–∞: \" + data.error);"
  print "          return;"
  print "        }"
  print ""
  print "        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫"
  print "        toggleAddRewardForm();"
  print "        loadRewards();"
  print "        "
  print "      } catch (err) {"
  print "        alert(\"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã: \" + err.message);"
  print "      }"
  print "    }"
  print ""
  print "    // –£–¥–∞–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã"
  print "    async function deleteReward(rewardId) {"
  print "      if (!confirm(\"–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –Ω–∞–≥—Ä–∞–¥—É?\")) {"
  print "        return;"
  print "      }"
  print ""
  print "      try {"
  print "        const res = await fetch(`${API_URL}/api/rewards/delete`, {"
  print "          method: \"DELETE\","
  print "          headers: {"
  print "            \"Content-Type\": \"application/json\","
  print "            \"X-Invite-Code\": currentCode"
  print "          },"
  print "          body: JSON.stringify({ reward_id: rewardId })"
  print "        });"
  print ""
  print "        const data = await res.json();"
  print "        "
  print "        if (data.error) {"
  print "          alert(\"–û—à–∏–±–∫–∞: \" + data.error);"
  print "          return;"
  print "        }"
  print ""
  print "        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫"
  print "        loadRewards();"
  print "        "
  print "      } catch (err) {"
  print "        alert(\"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã: \" + err.message);"
  print "      }"
  print "    }"
  print ""
  done = 1
}
{ print }
' "$WORKER_FILE" > "${WORKER_FILE}.tmp"

# –ó–∞–º–µ–Ω—è–µ–º —Ñ–∞–π–ª
mv "${WORKER_FILE}.tmp" "$WORKER_FILE"

echo "‚úÖ JavaScript —Ñ—É–Ω–∫—Ü–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã!"
echo "üìä –ù–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:"
wc -l "$WORKER_FILE"
