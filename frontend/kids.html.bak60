<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family Wallet ‚Äî –†–µ–±—ë–Ω–æ–∫</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    .section { margin: 30px 0; padding: 20px; border: 2px solid #ccc; }
    h1, h2 { margin-top: 0; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; font-size: 16px; }
    .task-item { padding: 15px; margin: 10px 0; border: 1px solid #ddd; background: #f9f9f9; }
    input { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
    .error { color: red; font-weight: bold; }
    .success { color: green; font-weight: bold; }
    .balance { font-size: 24px; font-weight: bold; margin: 20px 0; }
    .pending-dashboard { padding: 15px; margin: 10px 0; background: #fff4cc; border: 2px solid #ffcc00; font-size: 18px; font-weight: bold; }
    .status-IDLE { background: #f0f0f0; }
    .status-WAITING { background: #fff4cc; }
    .status-CONFIRMED { background: #d4edda; }
    .empty-state { text-align: center; padding: 40px; color: #999; font-size: 18px; }
    .history-item { padding: 10px; margin: 5px 0; background: #f9f9f9; border-left: 3px solid #4CAF50; }

    .reward-item { padding: 15px; margin: 10px 0; border: 2px solid #4CAF50; background: #f0fff0; border-radius: 8px; }
    .reward-icon { font-size: 48px; display: inline-block; margin-right: 15px; }
    .reward-info { display: inline-block; vertical-align: top; }
    .reward-price { font-size: 20px; font-weight: bold; color: #FF9800; margin: 10px 0; }
    .buy-button { background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 5px; font-size: 16px; cursor: pointer; }
    .buy-button:disabled { background: #ccc; cursor: not-allowed; }
    .my-reward-item { padding: 15px; margin: 10px 0; border: 2px solid #FF9800; background: #fff8e1; border-radius: 8px; }
    .confirm-button { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }

    .dream-dashboard { padding: 20px; margin: 20px 0; border: 2px solid #9C27B0; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-radius: 12px; position: relative; }
    .dream-input-form { display: flex; gap: 10px; align-items: center; }
    .dream-input { flex: 1; padding: 12px; border: 2px solid #9C27B0; border-radius: 8px; font-size: 16px; }
    .dream-button { background: #9C27B0; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
    .dream-button:hover { background: #7B1FA2; }
    .dream-close { position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px; }
    .dream-progress-bar { width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden; margin: 15px 0; }
    .dream-progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%); transition: width 0.3s; }
    .dream-status { color: #9C27B0; font-weight: bold; margin-top: 10px; }


    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
    .nav-tabs { display: flex; background: #333; margin: 0; padding: 0; }
    .nav-tabs button { flex: 1; padding: 15px; background: #333; color: white; border: none; cursor: pointer; font-size: 16px; }
    .nav-tabs button.active { background: #4CAF50; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }


    /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ú–∞–≥–∏–∏ */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –º–∏—Ä–æ–≤ */
    .magic-world-card:hover {
      transform: scale(1.05) !important;
      box-shadow: 0 8px 16px rgba(255, 215, 0, 0.3);
    }

    .magic-world-card:active {
      transform: scale(0.98) !important;
    }
  </style>
</head>
<body>
  <h1>üë∂ Family Wallet ‚Äî –†–µ–±—ë–Ω–æ–∫</h1>
  
  
  <div class="section">
    <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
    <input type="text" id="inviteCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Ä–µ–±—ë–Ω–∫–∞ (KID_STAS)" value="KID_STAS">
    <button onclick="login()">–í–æ–π—Ç–∏</button>
    <div id="authStatus"></div>
  </div>

  <div class="nav-tabs">
    <button class="active" onclick="showTab('tab-wallet')">üí∞ –ö–æ—à–µ–ª—ë–∫</button>
    <button onclick="showTab('tab-missions')">üéØ –ú–∏—Å—Å–∏–∏</button>
    <button onclick="showTab('tab-shop')">üéÅ –ú–∞–≥–∞–∑–∏–Ω</button>
    <button onclick="showTab('tab-magic')">‚ú® –ú–∞–≥–∏—è</button>
    <button onclick="showTab('tab-profile')">üë§ –Ø</button>
  </div>

  <!-- –í–∫–ª–∞–¥–∫–∞: –ö–æ—à–µ–ª—ë–∫ -->
  <div id="tab-wallet" class="tab-content active">
  <div class="section" id="dreamSection" style="display:none;">
    <div id="dreamDashboard"></div>
  </div>

  <div class="section" id="balanceSection" style="display:none;">
    <h2>–ú–æ–π –±–∞–ª–∞–Ω—Å</h2>
    <div class="balance" id="balanceDisplay"></div>
    <div id="pendingDashboard"></div>
  </div>

  <div class="section" id="myRewardsSection" style="display:none;">
    <h2>üéÅ –ú–æ–∏ –Ω–∞–≥—Ä–∞–¥—ã</h2>
    <div id="myRewardsList"></div>
  </div>

  <div class="section" id="historySection" style="display:none;">
    <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
    <div id="historyList"></div>
  </div>
  </div>

  <!-- –í–∫–ª–∞–¥–∫–∞: –ú–∏—Å—Å–∏–∏ -->
  <div id="tab-missions" class="tab-content">
  <div class="section" id="tasksSection" style="display:none;">
    <h2>–ú–æ–∏ –º–∏—Å—Å–∏–∏</h2>
    <!-- –ë–∞–ª–∞–Ω—Å -->
    <div style="margin: 15px 0; padding: 12px 20px; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
      <span style="font-size: 16px; font-weight: bold; color: #333;">üí∞ –ë–∞–ª–∞–Ω—Å</span>
      <span id="missionsBalance" style="font-size: 20px; font-weight: bold; color: #333;">0 ‚≠ê</span>
    </div>
    <div id="tasksList"></div>
  </div>
  </div>

  <!-- –í–∫–ª–∞–¥–∫–∞: –ú–∞–≥–∞–∑–∏–Ω -->
  <div id="tab-shop" class="tab-content">
  <div class="section" id="shopSection" style="display:none;">
    <h2>üõí –ú–∞–≥–∞–∑–∏–Ω –Ω–∞–≥—Ä–∞–¥</h2>
    <!-- –ë–∞–ª–∞–Ω—Å -->
    <div style="margin: 15px 0;">
      <!-- –î–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å -->
      <div style="margin-bottom: 10px; padding: 12px 20px; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 16px; font-weight: bold; color: #333;">üí∞ –î–æ—Å—Ç—É–ø–Ω–æ</span>
        <span id="shopBalance" style="font-size: 20px; font-weight: bold; color: #333;">0 ‚≠ê</span>
      </div>
      <!-- –ù–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ -->
      <div style="padding: 12px 20px; background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%); border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 16px; font-weight: bold; color: #333;">‚è≥ –ù–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏</span>
        <span id="shopPending" style="font-size: 20px; font-weight: bold; color: #333;">0 ‚≠ê</span>
      </div>
    </div>
    <div id="shopRewardsList"></div>
  </div>
  </div>


  <!-- –í–∫–ª–∞–¥–∫–∞: –ú–∞–≥–∏—è -->
  <div id="tab-magic" class="tab-content">
  <div class="section" id="magicSection" style="display:none;">
    <h2>‚ú® –ú–∞–≥–∏—è –∞–≤–∞—Ç–∞—Ä–∞</h2>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
    <div id="magicResult" style="display:none; margin: 20px 0;">
      <div style="position: relative; border: 3px solid #FFD700; border-radius: 12px; overflow: hidden;">
        <img id="magicImage" src="" alt="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≤–∞—Ç–∞—Ä" style="width: 100%; display: block;">
        <div style="position: absolute; top: 10px; right: 10px; background: rgba(76, 175, 80, 0.9); color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold;">
          ‚úì –ì–û–¢–û–í–û
        </div>
      </div>
      
      <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
      <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="downloadMagicImage()" style="flex: 1; min-width: 120px; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
          üì• –°–∫–∞—á–∞—Ç—å
        </button>
        <button onclick="shareMagicImage()" style="flex: 1; min-width: 120px; padding: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
          üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
        </button>
        <button onclick="setMagicAsAvatar()" style="flex: 1; min-width: 120px; padding: 12px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
          üë§ –ù–∞ –∞–≤–∞—Ç–∞—Ä–∫—É
        </button>
      </div>
      
      <!-- –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å –µ—â—ë" -->
      <button onclick="resetMagic()" style="width: 100%; margin-top: 10px; padding: 12px; background: #666; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
        üîÑ –°–æ–∑–¥–∞—Ç—å –µ—â—ë
      </button>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="magicLoading" style="display:none; text-align: center; padding: 40px 20px;">
      <div style="width: 80px; height: 80px; margin: 0 auto 20px; border: 5px solid #f3f3f3; border-top: 5px solid #FFD700; border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <h3 style="color: #FFD700; margin: 0;">‚ú® –ö–û–õ–î–£–ï–ú...</h3>
      <p style="color: #999; margin-top: 10px;">–°–æ–∑–¥–∞—ë–º —Ç–≤–æ–π –≤–æ–ª—à–µ–±–Ω—ã–π –∞–≤–∞—Ç–∞—Ä</p>
    </div>
    
    <!-- –í—ã–±–æ—Ä –∏–≥—Ä–æ–≤–æ–≥–æ –º–∏—Ä–∞ -->
      
      <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
      <div style="margin: 20px 0;">
        <p style="color: #FFD700; font-weight: bold; margin-bottom: 10px;">üì∑ –ó–ê–ì–†–£–ó–ò–¢–¨ –§–û–¢–û (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</p>
        <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
        <button onclick="document.getElementById('photoInput').click()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px;">
          üì∑ –í–´–ë–†–ê–¢–¨ –§–û–¢–û
        </button>
        
        <!-- –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ -->
        <div id="photoPreview" style="display: none; margin-top: 15px; text-align: center;">
          <img id="photoPreviewImage" style="max-width: 100%; max-height: 200px; border-radius: 12px; border: 3px solid #FFD700;">
          <p style="color: #FFD700; font-size: 14px; margin-top: 10px;">‚úÖ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ! AI —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –µ–≥–æ –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–∏–ª—å</p>
          <button onclick="clearPhoto()" style="margin-top: 10px; padding: 8px 15px; background: #ff4444; color: white; border: none; border-radius: 8px; cursor: pointer;">
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ
          </button>
        </div>
      </div>
    <div id="magicWorldSelector">
      <p style="color: #FFD700; font-weight: bold; margin: 20px 0 15px 0;">‚ö° –í–´–ë–ï–†–ò –ò–ì–†–û–í–û–ô –ú–ò–†:</p>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
        <!-- –†–æ–±–ª–æ–∫—Å -->
        <div onclick="selectWorld('roblox')" id="world-roblox" class="magic-world-card" style="cursor: pointer; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; text-align: center; transition: transform 0.2s; border: 3px solid transparent;">
          <div style="font-size: 48px; margin-bottom: 10px;">ü§ñ</div>
          <div style="color: white; font-weight: bold;">–†–û–ë–õ–û–ö–°</div>
        </div>
        
        <!-- –ì–∏–±–ª–∏ -->
        <div onclick="selectWorld('ghibli')" id="world-ghibli" class="magic-world-card" style="cursor: pointer; padding: 20px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 12px; text-align: center; transition: transform 0.2s; border: 3px solid transparent;">
          <div style="font-size: 48px; margin-bottom: 10px;">üå≥</div>
          <div style="color: #333; font-weight: bold;">–ì–ò–ë–õ–ò</div>
        </div>
        
        <!-- –ê–Ω–∏–º–µ -->
        <div onclick="selectWorld('anime')" id="world-anime" class="magic-world-card" style="cursor: pointer; padding: 20px; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-radius: 12px; text-align: center; transition: transform 0.2s; border: 3px solid transparent;">
          <div style="font-size: 48px; margin-bottom: 10px;">‚ú®</div>
          <div style="color: #333; font-weight: bold;">–ê–ù–ò–ú–ï</div>
        </div>
        
        <!-- –ú–∞–π–Ω–∫—Ä–∞—Ñ—Ç -->
        <div onclick="selectWorld('minecraft')" id="world-minecraft" class="magic-world-card" style="cursor: pointer; padding: 20px; background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); border-radius: 12px; text-align: center; transition: transform 0.2s; border: 3px solid transparent;">
          <div style="font-size: 48px; margin-bottom: 10px;">üé©</div>
          <div style="color: #333; font-weight: bold;">–ú–ê–ô–ù–ö–†–ê–§–¢</div>
        </div>
      </div>
      
      <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
      <button id="generateButton" onclick="generateMagic()" disabled style="width: 100%; margin-top: 20px; padding: 15px; background: #666; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: not-allowed;">
        ü™Ñ –°–û–ó–î–ê–¢–¨ –ê–í–ê–¢–ê–†
      </button>
    </div>
  </div>
  </div>
  <!-- –í–∫–ª–∞–¥–∫–∞: –Ø (–ü—Ä–æ—Ñ–∏–ª—å) -->
  <div id="tab-profile" class="tab-content">
    <div class="section">
      <h2>üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
      <div id="profileInfo">
        <p><strong>–ò–º—è:</strong> <span id="profileName">-</span></p>
        <p><strong>–ë–∞–ª–∞–Ω—Å:</strong> <span id="profileBalance">0</span> ‚ÇΩ</p>

        <div style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
          <h3 style="margin: 0 0 10px 0; font-size: 18px;">üèÜ <span id="profileLevelName">–ù–æ–≤–∏—á–æ–∫</span> <span id="profileLevelIcon">‚ù§Ô∏è</span></h3>
          <div style="position: relative; background: rgba(255,255,255,0.3); border-radius: 10px; height: 24px; overflow: hidden; margin-bottom: 8px;">
            <div id="profileProgressBar" style="background: white; height: 100%; width: 0%; transition: width 0.5s;"></div>
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
              <span id="marker0" style="position: absolute; left: 0%; top: 50%; transform: translate(0%, -50%); font-size: 16px; transition: opacity 0.3s;">‚ù§Ô∏è</span>
              <span id="marker25" style="position: absolute; left: 25%; top: 50%; transform: translate(-50%, -50%); font-size: 16px; opacity: 0.3; transition: opacity 0.3s;">üî∑</span>
              <span id="marker50" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 16px; opacity: 0.3; transition: opacity 0.3s;">üî∫</span>
              <span id="marker75" style="position: absolute; left: 75%; top: 50%; transform: translate(-50%, -50%); font-size: 16px; opacity: 0.3; transition: opacity 0.3s;">‚≠ê</span>
              <span id="marker100" style="position: absolute; left: 100%; top: 50%; transform: translate(-100%, -50%); font-size: 16px; opacity: 0.3; transition: opacity 0.3s;">üèÜ</span>
            </div>
          </div>
          <p style="margin: 0; font-size: 14px; opacity: 0.9;">
            <span id="profileProgressText">0/25 –º–∏—Å—Å–∏–π</span> ‚Ä¢ 
            <span id="profileProgressNext">–î–æ –û–ø—ã—Ç–Ω–æ–≥–æ: 25 –º–∏—Å—Å–∏–π</span>
          </p>
        </div>
        <p><strong>–í—ã–ø–æ–ª–Ω–µ–Ω–æ –º–∏—Å—Å–∏–π:</strong> <span id="profileMissionsCount">0</span></p>
        <p><strong>–ü–æ–ª—É—á–µ–Ω–æ –Ω–∞–≥—Ä–∞–¥:</strong> <span id="profileRewardsCount">0</span></p>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://family-wallet-api.maltsevstas21.workers.dev';
    let currentCode = '';
    let childId = '';
    let childName = '';
    let myRewards = [];

    async function login() {
      const code = document.getElementById('inviteCode').value.trim();
      if (!code) {
        document.getElementById('authStatus').innerHTML = '<p class="error">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥</p>';
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/auth/whoami`, {
          headers: { 'X-Invite-Code': code }
        });

        if (!res.ok) {
          const err = await res.json();
          document.getElementById('authStatus').innerHTML = `<p class="error">–û—à–∏–±–∫–∞: ${err.error}</p>`;
          return;
        }

        const data = await res.json();
        
        if (data.role !== 'child') {
          document.getElementById('authStatus').innerHTML = '<p class="error">–≠—Ç–æ—Ç –∫–æ–¥ –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ—Ç—Å–∫–∏–π –∫–æ–¥.</p>';
          return;
        }

        currentCode = code;
        childId = data.child_id;
        childName = data.name;
        
        document.getElementById('authStatus').innerHTML = `<p class="success">‚úÖ –ü—Ä–∏–≤–µ—Ç, ${data.name}!</p>`;
        document.getElementById('balanceSection').style.display = 'block';
        document.getElementById('tasksSection').style.display = 'block';
        document.getElementById('historySection').style.display = 'block';
        document.getElementById('dreamSection').style.display = 'block';
        document.getElementById('myRewardsSection').style.display = 'block';
        document.getElementById('shopSection').style.display = 'block';

        updateBalance(data.balance, data.pending_balance);
        loadTasks();
        loadHistory();
        loadMyRewards();
        loadShopRewards();
        loadMyDream();

      } catch (err) {
        document.getElementById('authStatus').innerHTML = `<p class="error">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${err.message}</p>`;
      }
    }

    function updateBalance(balance, pending) {
      document.getElementById('balanceDisplay').innerHTML = `${balance} ‚≠ê`;
      
      if (pending > 0) {
        document.getElementById('pendingDashboard').innerHTML = `
          <div class="pending-dashboard">
            ‚è≥ –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: ${pending} ‚≠ê
          </div>
        `;
      } else {
        document.getElementById('pendingDashboard').innerHTML = '';
      }
    }

    async function loadTasks() {
      try {
        const res = await fetch(`${API_URL}/api/tasks/list`, {
          headers: { 'X-Invite-Code': currentCode }
        });

        const data = await res.json();
        
        if (!Array.isArray(data.tasks)) {
          document.getElementById('tasksList').innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏—Å—Å–∏–π</p>';
          return;
        }

        const activeTasks = data.tasks.filter(t => t.status === 'IDLE' || t.status === 'WAITING' || t.status === 'REJECTED');

        if (activeTasks.length === 0) {
          document.getElementById('tasksList').innerHTML = '<div class="empty-state">üì≠ –ú–∏—Å—Å–∏–π –ø–æ–∫–∞ –Ω–µ—Ç<br><small>–û–±—Ä–∞—Ç–∏—Å—å –∫ —Ä–æ–¥–∏—Ç–µ–ª—é</small></div>';
          return;
        }

        document.getElementById('tasksList').innerHTML = activeTasks.map(task => {
          let buttonHtml = '';
          let statusText = '';

          if (task.status === 'IDLE' || task.status === 'REJECTED') {
            buttonHtml = `<button onclick="completeTask('${task.id}')">‚úÖ –Ø —ç—Ç–æ —Å–¥–µ–ª–∞–ª!</button>`;
            statusText = task.status === 'REJECTED' ? '<strong style="color: red;">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ ‚Äî –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑</strong>' : '';
          } else if (task.status === 'WAITING') {
            buttonHtml = '';
            statusText = '<strong style="color: orange;">‚è≥ –û–∂–∏–¥–∞–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è!</strong>';
          }

          return `
            <div class="task-item status-${task.status}">
              <strong>${task.icon || '‚úÖ'} ${task.title}</strong> ‚Äî ${task.reward_amount} ‚≠ê<br>
              ${task.description || ''}<br>
              ${statusText}
              ${buttonHtml}
            </div>
          `;
        }).join('');

      } catch (err) {
        document.getElementById('tasksList').innerHTML = `<p class="error">–û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }

    async function loadHistory() {
      try {
        const res = await fetch(`${API_URL}/api/tasks/list`, {
          headers: { 'X-Invite-Code': currentCode }
        });

        const data = await res.json();
        
        if (!Array.isArray(data.tasks)) {
          return;
        }

        const completedTasks = data.tasks.filter(t => t.status === 'CONFIRMED');

        if (completedTasks.length === 0) {
          document.getElementById('historyList').innerHTML = '<div class="empty-state">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
          return;
        }

        document.getElementById('historyList').innerHTML = completedTasks.map(task => `
          <div class="history-item">
            ‚úÖ ${task.title} ‚Äî +${task.reward_amount} ‚≠ê
          </div>
        `).join('');

      } catch (err) {
        document.getElementById('historyList').innerHTML = `<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</p>`;
      }
    }

    async function completeTask(taskId) {
      try {
        const res = await fetch(`${API_URL}/api/tasks/complete`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Invite-Code': currentCode
          },
          body: JSON.stringify({ task_id: taskId })
        });

        const data = await res.json();
        
        // –ë–µ–∑ alert ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI
        loadTasks();
        loadHistory();
        loadMyRewards();
        loadShopRewards();
        loadMyDream();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
        const authRes = await fetch(`${API_URL}/api/auth/whoami`, {
          headers: { 'X-Invite-Code': currentCode }
        });
        const authData = await authRes.json();
        updateBalance(authData.balance, authData.pending_balance);

      } catch (err) {
        console.error('–û—à–∏–±–∫–∞:', err);
      }
    }

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    setInterval(() => {
      if (currentCode) {
        loadTasks();
        loadHistory();
        loadMyRewards();
        loadShopRewards();
        loadMyDream();
        
        fetch(`${API_URL}/api/auth/whoami`, {
          headers: { 'X-Invite-Code': currentCode }
        })
        .then(r => r.json())
        .then(d => updateBalance(d.balance, d.pending_balance))
        .catch(() => {});
      }
    }, 5000);

    // ============================
    // –ú–ê–ì–ê–ó–ò–ù –ù–ê–ì–†–ê–î
    // ============================

    async function loadShopRewards() {
      try {
        const res = await fetch(`${API_URL}/api/rewards/list`, {
          headers: { 'X-Invite-Code': currentCode }
        });
        
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–≥—Ä–∞–¥');
        
        const data = await res.json();
        const list = document.getElementById('shopRewardsList');
        
        if (!data.rewards || data.rewards.length === 0) {
          list.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥</div>';
          return;
        }
        
        list.innerHTML = data.rewards.map(reward => `
          <div class="reward-item">
            <span class="reward-icon">${reward.icon}</span>
            <div class="reward-info">
              <h3>${reward.title}</h3>
              <p>${reward.description || ''}</p>
              <div class="reward-price">${reward.price} ‚≠ê</div>
              <button class="buy-button" onclick="purchaseReward('${reward.id}', ${reward.price})">
                –ö—É–ø–∏—Ç—å –∑–∞ ${reward.price} ‚≠ê
              </button>
            </div>
          </div>
        `).join('');
        
      } catch (err) {
        document.getElementById('shopRewardsList').innerHTML = 
          `<p class="error">–û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }

    async function purchaseReward(rewardId, price) {
      const currentBalance = parseInt(document.getElementById('balanceDisplay').innerText.split(':')[1]);
      
      if (currentBalance < price) {
        alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!');
        return;
      }
      
      if (!confirm(`–ö—É–ø–∏—Ç—å —ç—Ç—É –Ω–∞–≥—Ä–∞–¥—É –∑–∞ ${price} ‚≠ê?`)) return;
      
      try {
        const res = await fetch(`${API_URL}/api/rewards/purchase`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Invite-Code': currentCode
          },
          body: JSON.stringify({ reward_id: rewardId })
        });
        
        if (!res.ok) {
          const err = await res.json();
          alert(`–û—à–∏–±–∫–∞: ${err.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∫—É–ø–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É'}`);
          return;
        }
        
        const data = await res.json();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∏ —Å–ø–∏—Å–∫–∏
        updateBalance(data.new_balance, 0);
        loadShopRewards();
        loadMyDream();
        loadMyRewards();
        
      } catch (err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
      }
    }

    async function loadMyRewards() {
      try {
        const res = await fetch(`${API_URL}/api/rewards/purchases`, {
          headers: { 'X-Invite-Code': currentCode }
        });
        
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫');
        
        const data = await res.json();
        const list = document.getElementById('myRewardsList');
        
        myRewards = data.purchases || [];
        if (!data.purchases || data.purchases.length === 0) {
          list.innerHTML = '<div class="empty-state">–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∞–≥—Ä–∞–¥</div>';
          return;
        }
        
        list.innerHTML = data.purchases.filter(p => p.status === 'pending').map(purchase => `
          <div class="my-reward-item">
            <span class="reward-icon">${purchase.reward_icon}</span>
            <div class="reward-info">
              <h3>${purchase.reward_title}</h3>
              <div class="reward-price">${purchase.price} ‚≠ê</div>
              <p style="color: #FF9800; font-weight: bold;">‚è≥ –û–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏</p>
              <button class="confirm-button" onclick="confirmReceived('${purchase.id}')">
                –ü–æ–ª—É—á–∏–ª –Ω–∞–≥—Ä–∞–¥—É ‚úÖ
              </button>
            </div>
          </div>
        `).join('');
        
      } catch (err) {
        document.getElementById('myRewardsList').innerHTML = 
          `<p class="error">–û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }

    async function confirmReceived(purchaseId) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞–≥—Ä–∞–¥—ã
      const reward = myRewards.find(r => r.id === purchaseId);
      if (!reward || reward.status === 'received') {
        alert('–≠—Ç–∞ –Ω–∞–≥—Ä–∞–¥–∞ —É–∂–µ –ø–æ–ª—É—á–µ–Ω–∞!');
        return;
      }

      
      try {
        const res = await fetch(`${API_URL}/api/rewards/confirm-received`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Invite-Code': currentCode
          },
          body: JSON.stringify({ purchase_id: purchaseId })
        });
        
        if (!res.ok) {
          const err = await res.json();
          alert(`–û—à–∏–±–∫–∞: ${err.error}`);
          return;
        }
        
        const data = await res.json();
        
        loadMyRewards();
        
      } catch (err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
      }
    }


    // ============================
    // –ú–ï–ß–¢–´ –†–ï–ë–Å–ù–ö–ê
    // ============================

    async function loadMyDream() {
      // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç
      const input = document.getElementById('dreamTitleInput');
      if (input && document.activeElement === input) {
        return;
      }
      
      try {
        const res = await fetch(`${API_URL}/api/dreams/my`, {
          headers: { 'X-Invite-Code': currentCode }
        });
        
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—á—Ç—ã');
        
        const data = await res.json();
        const dashboard = document.getElementById('dreamDashboard');
        
        if (!data.dream) {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –º–µ—á—Ç—ã
          dashboard.innerHTML = `
            <div class="dream-dashboard">
              <h2>üí≠ –ú–æ—è –º–µ—á—Ç–∞</h2>
              <div class="dream-input-form">
                <input type="text" id="dreamTitleInput" class="dream-input" placeholder="–û —á—ë–º —Ç—ã –º–µ—á—Ç–∞–µ—à—å?" maxlength="100">
                <button class="dream-button" onclick="createDream()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>
          `;
          return;
        }
        
        const dream = data.dream;
        
        if (dream.status === 'pending') {
          // –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–æ–¥–∏—Ç–µ–ª—è
          dashboard.innerHTML = `
            <div class="dream-dashboard">
              <button class="dream-close" onclick="deleteDream('${dream.id}')">‚úï</button>
              <h2>üéØ ${dream.title}</h2>
              <div class="dream-status">‚è≥ –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–æ–¥–∏—Ç–µ–ª—è...</div>
            </div>
          `;
        } else if (dream.status === 'active') {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
          const progress = Math.min(100, Math.round((dream.current_amount / dream.target_amount) * 100));
          
          dashboard.innerHTML = `
            <div class="dream-dashboard">
              <button class="dream-close" onclick="deleteDream('${dream.id}')">‚úï</button>
              <h2>üéØ ${dream.title}</h2>
              <div class="dream-progress-bar">
                <div class="dream-progress-fill" style="width: ${progress}%"></div>
              </div>
              <div style="font-size: 18px; font-weight: bold; text-align: center;">
                ${dream.current_amount} / ${dream.target_amount} ‚≠ê
              </div>
              <div style="text-align: center; color: #666; margin-top: 5px;">
                –ü—Ä–æ–≥—Ä–µ—Å—Å: ${progress}%
              </div>
            </div>
          `;
        }
        
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—á—Ç—ã:', err);
      }
    }

    async function createDream() {
      const input = document.getElementById('dreamTitleInput');
      const title = input.value.trim();
      
      if (!title) {
        alert('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—á—Ç—ã!');
        return;
      }
      
      try {
        const res = await fetch(`${API_URL}/api/dreams/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Invite-Code': currentCode
          },
          body: JSON.stringify({ title })
        });
        
        if (!res.ok) {
          const err = await res.json();
          alert(`–û—à–∏–±–∫–∞: ${err.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –º–µ—á—Ç—É'}`);
          return;
        }
        
        const data = await res.json();
        
        loadMyDream();
        
      } catch (err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
      }
    }

    async function deleteDream(dreamId) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –º–µ—á—Ç—É?')) return;
      
      try {
        const res = await fetch(`${API_URL}/api/dreams/delete`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'X-Invite-Code': currentCode
          },
          body: JSON.stringify({ dream_id: dreamId })
        });
        
        if (!res.ok) {
          const err = await res.json();
          alert(`–û—à–∏–±–∫–∞: ${err.error}`);
          return;
        }
        
        const data = await res.json();
        alert(`‚úÖ ${data.message}`);
        loadMyDream();
        
      } catch (err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
      }
    }



    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.nav-tabs button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active');
      
      // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫–∏
      if (tabId === 'tab-profile') loadProfile();
      if (tabId === 'tab-missions') loadMissionsBalance();
      if (tabId === 'tab-shop') loadShopBalance();
      if (tabId === 'tab-magic') showMagicTab();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –ú–∏—Å—Å–∏–∏
    async function loadMissionsBalance() {
      try {
        const res = await fetch(`${API_URL}/api/auth/whoami`, {
          headers: { 'X-Invite-Code': currentCode }
        });
        const data = await res.json();
        document.getElementById('missionsBalance').textContent = `${data.balance || 0} ‚≠ê`;
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞ –º–∏—Å—Å–∏–π:', e);
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –ú–∞–≥–∞–∑–∏–Ω
    async function loadShopBalance() {
      try {
        const res = await fetch(`${API_URL}/api/auth/whoami`, {
          headers: { 'X-Invite-Code': currentCode }
        });
        const data = await res.json();
        
        document.getElementById('shopBalance').textContent = `${data.balance || 0} ‚≠ê`;
        document.getElementById('shopPending').textContent = `${data.pending_balance || 0} ‚≠ê`;
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞ –º–∞–≥–∞–∑–∏–Ω–∞:', e);
      }
    }

    async function loadProfile() {
      try {
        const res = await fetch(`${API_URL}/api/auth/whoami`, {
          headers: { 'X-Invite-Code': currentCode }
        });

        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è');

        const data = await res.json();

        // –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—ã
        const rewardsRes = await fetch(`${API_URL}/api/rewards/received`, {
          headers: { 'X-Invite-Code': currentCode }
        });
        const rewardsData = await rewardsRes.json();

        // –ü–æ–ª—É—á–∏—Ç—å –º–∏—Å—Å–∏–∏
        const tasksRes = await fetch(`${API_URL}/api/tasks/list`, {
          headers: { 'X-Invite-Code': currentCode }
        });
        const tasksData = await tasksRes.json();

        // –û–±–Ω–æ–≤–∏—Ç—å UI
        document.getElementById('profileName').textContent = data.name || '–†–µ–±—ë–Ω–æ–∫';
        document.getElementById('profileBalance').textContent = data.balance || 0;
        document.getElementById('profileMissionsCount').textContent = 
          (tasksData.tasks || []).filter(t => t.status === 'CONFIRMED').length;
        document.getElementById('profileRewardsCount').textContent = rewardsData.count || 0;

        // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∏ —É—Ä–æ–≤–µ–Ω—å
        const missionsCount = (tasksData.tasks || []).filter(t => t.status === 'CONFIRMED').length;
        const levels = [
          { name: '–ù–æ–≤–∏—á–æ–∫', icon: '‚ù§Ô∏è', min: 0, max: 24, next: '–û–ø—ã—Ç–Ω–æ–≥–æ' },
          { name: '–û–ø—ã—Ç–Ω—ã–π', icon: 'üî∑', min: 25, max: 49, next: '–ú–∞—Å—Ç–µ—Ä–∞' },
          { name: '–ú–∞—Å—Ç–µ—Ä', icon: 'üî∫', min: 50, max: 74, next: '–≠–∫—Å–ø–µ—Ä—Ç–∞' },
          { name: '–≠–∫—Å–ø–µ—Ä—Ç', icon: '‚≠ê', min: 75, max: 99, next: '–õ–µ–≥–µ–Ω–¥—ã' },
          { name: '–õ–µ–≥–µ–Ω–¥–∞', icon: 'üèÜ', min: 100, max: Infinity, next: null }
        ];

        const currentLevel = levels.find(l => missionsCount >= l.min && missionsCount <= l.max);
        const progress = currentLevel.max === Infinity 
          ? 100 
          : Math.round(((missionsCount - currentLevel.min) / (currentLevel.max - currentLevel.min + 1)) * 100);
        const remaining = currentLevel.max === Infinity ? 0 : currentLevel.max - missionsCount + 1;

        document.getElementById('profileLevelName').textContent = currentLevel.name;
        document.getElementById('profileLevelIcon').textContent = currentLevel.icon;
        document.getElementById('profileProgressBar').style.width = progress + '%';
        document.getElementById('profileProgressText').textContent = 
          currentLevel.max === Infinity 
            ? `${missionsCount} –º–∏—Å—Å–∏–π (–ú–∞–∫—Å–∏–º—É–º!)` 
            : `${missionsCount}/${currentLevel.max + 1} –º–∏—Å—Å–∏–π`;
        
        // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –º–∞—Ä–∫–µ—Ä–æ–≤ —É—Ä–æ–≤–Ω–µ–π
        document.getElementById('marker0').style.opacity = missionsCount >= 0 ? '1' : '0.3';
        document.getElementById('marker25').style.opacity = missionsCount >= 25 ? '1' : '0.3';
        document.getElementById('marker50').style.opacity = missionsCount >= 50 ? '1' : '0.3';
        document.getElementById('marker75').style.opacity = missionsCount >= 75 ? '1' : '0.3';
        document.getElementById('marker100').style.opacity = missionsCount >= 100 ? '1' : '0.3';

        document.getElementById('profileProgressNext').textContent = 
          currentLevel.next 
            ? `–î–æ ${currentLevel.next}: ${remaining} –º–∏—Å—Å–∏–π` 
            : '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å!';
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', e);
      }
    }


    // === –ú–ê–ì–ò–Ø: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===
    let selectedWorld = null;
    let magicImageUrl = null;

    // === –ú–ê–ì–ò–Ø: –ü–æ–∫–∞–∑–∞—Ç—å –≤–∫–ª–∞–¥–∫—É ===
    function showMagicTab() {
      document.getElementById('magicSection').style.display = 'block';
      resetMagic();
    }

    // === –ú–ê–ì–ò–Ø: –í—ã–±–æ—Ä –º–∏—Ä–∞ ===
    function selectWorld(world) {
      selectedWorld = world;
      
      // –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
      document.querySelectorAll('.magic-world-card').forEach(card => {
        card.style.border = '3px solid transparent';
        card.style.transform = 'scale(1)';
      });
      
      // –í—ã–¥–µ–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
      const selectedCard = document.getElementById(`world-${world}`);
      selectedCard.style.border = '3px solid #FFD700';
      selectedCard.style.transform = 'scale(1.05)';
      
      // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      const button = document.getElementById('generateButton');
      button.disabled = false;
      button.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
      button.style.cursor = 'pointer';
    }

    // === –ú–ê–ì–ò–Ø: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–≤–∞—Ç–∞—Ä–∞ ===
    async function generateMagic() {
      if (!selectedWorld) {
        alert('–í—ã–±–µ—Ä–∏ –∏–≥—Ä–æ–≤–æ–π –º–∏—Ä!');
        return;
      }
      
      // –°–∫—Ä—ã—Ç—å —Å–µ–ª–µ–∫—Ç–æ—Ä, –ø–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
      document.getElementById('magicWorldSelector').style.display = 'none';
      document.getElementById('magicLoading').style.display = 'block';
      
      try {
        // –í—ã–∑–æ–≤ API –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        const res = await fetch(`${API_URL}/api/magic/generate`, {
          method: 'POST',
          headers: {
            'X-Invite-Code': currentCode,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            world: selectedWorld
          })
        });
        
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
        
        const data = await res.json();
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        magicImageUrl = data.image_url;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        document.getElementById('magicLoading').style.display = 'none';
        document.getElementById('magicResult').style.display = 'block';
        document.getElementById('magicImage').src = magicImageUrl;
        
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞: ' + e.message);
        resetMagic();
      }
    }

    // === –ú–ê–ì–ò–Ø: –°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ===
    function downloadMagicImage() {
      if (!magicImageUrl) return;
      
      const link = document.createElement('a');
      link.href = magicImageUrl;
      link.download = `magic-avatar-${selectedWorld}-${Date.now()}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // === –ú–ê–ì–ò–Ø: –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ===
    async function shareMagicImage() {
      if (!magicImageUrl) return;
      
      if (navigator.share) {
        try {
          await navigator.share({
            title: '–ú–æ–π –º–∞–≥–∏—á–µ—Å–∫–∏–π –∞–≤–∞—Ç–∞—Ä',
            text: `–Ø —Å–æ–∑–¥–∞–ª –∞–≤–∞—Ç–∞—Ä –≤ —Å—Ç–∏–ª–µ ${selectedWorld}!`,
            url: magicImageUrl
          });
        } catch (e) {
          console.log('–û—Ç–º–µ–Ω–∞ —à–∞—Ä–∏–Ω–≥–∞', e);
        }
      } else {
        // Fallback: –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL
        navigator.clipboard.writeText(magicImageUrl);
        alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
      }
    }

    // === –ú–ê–ì–ò–Ø: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–∫ –∞–≤–∞—Ç–∞—Ä–∫—É ===
    async function setMagicAsAvatar() {
      if (!magicImageUrl) return;
      
      try {
        const res = await fetch(`${API_URL}/api/profile/set-avatar`, {
          method: 'POST',
          headers: {
            'X-Invite-Code': currentCode,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            avatar_url: magicImageUrl
          })
        });
        
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞');
        
        alert('‚úÖ –ê–≤–∞—Ç–∞—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');
        
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
      }
    }

    // === –ú–ê–ì–ò–Ø: –°–±—Ä–æ—Å (—Å–æ–∑–¥–∞—Ç—å –µ—â—ë) ===
    function resetMagic() {
      selectedWorld = null;
      magicImageUrl = null;
      
      // –°–∫—Ä—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –∑–∞–≥—Ä—É–∑–∫—É
      document.getElementById('magicResult').style.display = 'none';
      document.getElementById('magicLoading').style.display = 'none';
      
      // –ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–ª–µ–∫—Ç–æ—Ä
      document.getElementById('magicWorldSelector').style.display = 'block';
      
      // –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä –º–∏—Ä–∞
      document.querySelectorAll('.magic-world-card').forEach(card => {
        card.style.border = '3px solid transparent';
        card.style.transform = 'scale(1)';
      });
      
      // –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É
      const button = document.getElementById('generateButton');
      button.disabled = true;
      button.style.background = '#666';
      button.style.cursor = 'not-allowed';
    }

  </script>
</body>
</html>
