<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family Wallet ‚Äî –†–æ–¥–∏—Ç–µ–ª—å</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
    .header { background: linear-gradient(135deg, #40a33f 0%, #2d7a2d 100%); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .container { max-width: 600px; margin: 20px auto; padding: 20px; }
    .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    input, button { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
    button { background: #40a33f; color: white; border: none; cursor: pointer; font-weight: bold; }
    button:hover { background: #2d7a2d; }
    .tabs { display: flex; background: white; border-radius: 10px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; }
    .tab.active { border-bottom-color: #40a33f; font-weight: bold; color: #40a33f; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .child-card { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #40a33f; }
    .task-card { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
    .task-title { font-weight: bold; margin-bottom: 5px; }
    .task-reward { color: #40a33f; font-weight: bold; }
    .hidden { display: none; }
    .add-button { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #40a33f; color: white; border-radius: 50%; font-size: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; }
    .add-button:hover { background: #2d7a2d; transform: scale(1.1); }
  </style>
</head>
<body>
  <div class="header">
    <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Wallet ‚Äî –†–æ–¥–∏—Ç–µ–ª—å</h1>
  </div>

  <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
  <div id="authScreen" class="container">
    <div class="card">
      <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
      <input type="text" id="inviteCodeInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥" value="SRFK4A1C">
      <button onclick="login()">–í–æ–π—Ç–∏</button>
    </div>
  </div>

  <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
  <div id="mainScreen" class="hidden">
    <div class="container">
      <div class="card">
        <h2 id="welcomeText">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
        <p>–í–∞–ª—é—Ç–∞: <span id="currencySymbol">‚≠ê</span></p>
      </div>

      <div class="tabs">
        <div class="tab active" onclick="switchTab('home')">–ì–ª–∞–≤–Ω–∞—è</div>
        <div class="tab" onclick="switchTab('missions')">–ú–∏—Å—Å–∏–∏</div>
        <div class="tab" onclick="switchTab('shop')">–ú–∞–≥–∞–∑–∏–Ω</div>
        <div class="tab" onclick="switchTab('ai')">–ò–ò</div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –ì–ª–∞–≤–Ω–∞—è -->
      <div id="homeTab" class="tab-content active">
        <div class="card">
          <h3>–ú–æ–∏ –¥–µ—Ç–∏</h3>
          <div id="childrenList"></div>
          <p id="noChildrenMessage" class="hidden">–î–æ–±–∞–≤—å—Ç–µ –¥–µ—Ç–µ–π, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!</p>
        </div>

        <div class="card">
          <h3>–ó–∞–¥–∞—á–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</h3>
          <div id="pendingTasksList"></div>
          <p id="noPendingMessage" class="hidden">–ù–µ—Ç –∑–∞–¥–∞—á –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</p>
        </div>

        <div class="card">
          <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
          <div id="historyList"></div>
          <p id="noHistoryMessage" class="hidden">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –ú–∏—Å—Å–∏–∏ -->
      <div id="missionsTab" class="tab-content">
        <div class="card">
          <h3>–í—Å–µ –º–∏—Å—Å–∏–∏</h3>
          <div id="allMissionsList"></div>
          <p id="noMissionsMessage" class="hidden">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –º–∏—Å—Å–∏—é!</p>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –ú–∞–≥–∞–∑–∏–Ω -->
      <div id="shopTab" class="tab-content">
        <div class="card">
          <h3>–ú–∞–≥–∞–∑–∏–Ω –ø—Ä–∏–∑–æ–≤</h3>
          <p>–°–∫–æ—Ä–æ...</p>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –ò–ò -->
      <div id="aiTab" class="tab-content">
        <div class="card">
          <h3>–ò–ò –ü–æ–º–æ—â–Ω–∏–∫</h3>
          <p>–°–∫–æ—Ä–æ...</p>
        </div>
      </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <div class="add-button" onclick="showAddMenu()">+</div>
  </div>

  <script>
    const API_BASE = 'https://family-wallet-api.maltsevstas21.workers.dev';
    let currentCode = '';
    let familyId = '';

    // –í–ê–ñ–ù–û: –û–±—ä—è–≤–ª—è–µ–º loadHistory() –î–û login()
    function loadHistory() {
      fetch(`${API_BASE}/api/tasks/list`, {
        headers: { 'X-Invite-Code': currentCode }
      })
      .then(r => r.json())
      .then(data => {
        const tasks = data.tasks || [];
        const confirmed = tasks.filter(t => t.status === 'CONFIRMED');
        const historyEl = document.getElementById('historyList');
        const noHistoryEl = document.getElementById('noHistoryMessage');

        if (confirmed.length === 0) {
          historyEl.innerHTML = '';
          noHistoryEl.classList.remove('hidden');
        } else {
          noHistoryEl.classList.add('hidden');
          historyEl.innerHTML = confirmed.map(task => `
            <div class="task-card">
              <div class="task-title">${task.title} <small>(${task.child_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'})</small></div>
              <div>${task.description || ''}</div>
              <div class="task-reward">+${task.reward_amount} ‚≠ê</div>
            </div>
          `).join('');
        }
      })
      .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', err));
    }

    function login() {
      const code = document.getElementById('inviteCodeInput').value.trim();
      if (!code) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥!');

      fetch(`${API_BASE}/api/auth/whoami`, {
        headers: { 'X-Invite-Code': code }
      })
      .then(r => r.json())
      .then(data => {
        if (data.role === 'parent') {
          currentCode = code;
          familyId = data.family_id;
          document.getElementById('welcomeText').textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${data.family_name || '–†–æ–¥–∏—Ç–µ–ª—å'}!`;
          document.getElementById('currencySymbol').textContent = data.currency?.symbol || '‚≠ê';
          document.getElementById('authScreen').classList.add('hidden');
          document.getElementById('mainScreen').classList.remove('hidden');
          loadChildren();
          loadPendingTasks();
          loadHistory();
          loadAllMissions();
          setInterval(() => {
            loadChildren();
            loadPendingTasks();
            loadHistory();
          }, 5000);
        } else {
          alert('–≠—Ç–æ—Ç –∫–æ–¥ –¥–ª—è —Ä–µ–±—ë–Ω–∫–∞!');
        }
      })
      .catch(err => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message));
    }

    function loadChildren() {
      fetch(`${API_BASE}/api/children/list`, {
        headers: { 'X-Invite-Code': currentCode }
      })
      .then(r => r.json())
      .then(data => {
        const children = data.children || [];
        const listEl = document.getElementById('childrenList');
        const noChildrenEl = document.getElementById('noChildrenMessage');

        if (children.length === 0) {
          listEl.innerHTML = '';
          noChildrenEl.classList.remove('hidden');
        } else {
          noChildrenEl.classList.add('hidden');
          listEl.innerHTML = children.map(child => `
            <div class="child-card">
              <strong>${child.name}</strong> (${child.age} –ª–µ—Ç, ${child.role})
              <br>–ë–∞–ª–∞–Ω—Å: ${child.balance} ‚≠ê | –í –æ–∂–∏–¥–∞–Ω–∏–∏: ${child.pending_balance} ‚≠ê
              <br><small>–ö–æ–¥: ${child.invite_code}</small>
            </div>
          `).join('');
        }
      })
      .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–µ–π:', err));
    }

    function loadPendingTasks() {
      fetch(`${API_BASE}/api/tasks/list`, {
        headers: { 'X-Invite-Code': currentCode }
      })
      .then(r => r.json())
      .then(data => {
        const tasks = data.tasks || [];
        const pending = tasks.filter(t => t.status === 'PENDING');
        const listEl = document.getElementById('pendingTasksList');
        const noPendingEl = document.getElementById('noPendingMessage');

        if (pending.length === 0) {
          listEl.innerHTML = '';
          noPendingEl.classList.remove('hidden');
        } else {
          noPendingEl.classList.add('hidden');
          listEl.innerHTML = pending.map(task => `
            <div class="task-card">
              <div class="task-title">${task.title} <small>(${task.child_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'})</small></div>
              <div>${task.description || ''}</div>
              <div class="task-reward">+${task.reward_amount} ‚≠ê</div>
              <button onclick="confirmTask('${task.id}', 'confirm')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
              <button onclick="confirmTask('${task.id}', 'reject')" style="background:#ff4444">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
          `).join('');
        }
      })
      .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ:', err));
    }

    function loadAllMissions() {
      fetch(`${API_BASE}/api/tasks/list`, {
        headers: { 'X-Invite-Code': currentCode }
      })
      .then(r => r.json())
      .then(data => {
        const tasks = data.tasks || [];
        const listEl = document.getElementById('allMissionsList');
        const noMissionsEl = document.getElementById('noMissionsMessage');

        if (tasks.length === 0) {
          listEl.innerHTML = '';
          noMissionsEl.classList.remove('hidden');
        } else {
          noMissionsEl.classList.add('hidden');
          listEl.innerHTML = tasks.map(task => `
            <div class="task-card">
              <div class="task-title">${task.title} <small>(${task.child_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'})</small></div>
              <div>${task.description || ''}</div>
              <div class="task-reward">+${task.reward_amount} ‚≠ê | –°—Ç–∞—Ç—É—Å: ${task.status}</div>
              <button onclick="deleteTask('${task.id}')" style="background:#ff4444">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          `).join('');
        }
      })
      .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –º–∏—Å—Å–∏–π:', err));
    }

    function confirmTask(taskId, action) {
      fetch(`${API_BASE}/api/tasks/confirm`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Invite-Code': currentCode },
        body: JSON.stringify({ task_id: taskId, action })
      })
      .then(r => r.json())
      .then(data => {
        alert(data.message || '–ó–∞–¥–∞—á–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞');
        loadChildren();
        loadPendingTasks();
        loadHistory();
        loadAllMissions();
      })
      .catch(err => alert('–û—à–∏–±–∫–∞: ' + err.message));
    }

    function deleteTask(taskId) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
      fetch(`${API_BASE}/api/tasks/delete`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', 'X-Invite-Code': currentCode },
        body: JSON.stringify({ task_id: taskId })
      })
      .then(r => r.json())
      .then(data => {
        alert(data.message || '–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞');
        loadAllMissions();
      })
      .catch(err => alert('–û—à–∏–±–∫–∞: ' + err.message));
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      if (tab === 'home') {
        document.querySelector('.tabs .tab:nth-child(1)').classList.add('active');
        document.getElementById('homeTab').classList.add('active');
      } else if (tab === 'missions') {
        document.querySelector('.tabs .tab:nth-child(2)').classList.add('active');
        document.getElementById('missionsTab').classList.add('active');
      } else if (tab === 'shop') {
        document.querySelector('.tabs .tab:nth-child(3)').classList.add('active');
        document.getElementById('shopTab').classList.add('active');
      } else if (tab === 'ai') {
        document.querySelector('.tabs .tab:nth-child(4)').classList.add('active');
        document.getElementById('aiTab').classList.add('active');
      }
    }

    function showAddMenu() {
      const choice = prompt('–ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å?\n1 - –†–µ–±—ë–Ω–∫–∞\n2 - –ú–∏—Å—Å–∏—é\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä:');
      if (choice === '1') addChild();
      else if (choice === '2') addTask();
    }

    function addChild() {
      const name = prompt('–ò–º—è —Ä–µ–±—ë–Ω–∫–∞:');
      if (!name) return;
      const role = prompt('–†–æ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: –°—ã–Ω/–î–æ—á–∫–∞):');
      const age = prompt('–í–æ–∑—Ä–∞—Å—Ç:');

      fetch(`${API_BASE}/api/children/add`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Invite-Code': currentCode },
        body: JSON.stringify({ name, role, age: parseInt(age) })
      })
      .then(r => r.json())
      .then(data => {
        alert(`–†–µ–±—ë–Ω–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω!\n–ö–æ–¥: ${data.child?.invite_code}`);
        loadChildren();
      })
      .catch(err => alert('–û—à–∏–±–∫–∞: ' + err.message));
    }

    function addTask() {
      fetch(`${API_BASE}/api/children/list`, {
        headers: { 'X-Invite-Code': currentCode }
      })
      .then(r => r.json())
      .then(data => {
        const children = data.children || [];
        if (children.length === 0) return alert('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –¥–µ—Ç–µ–π!');

        const childList = children.map((c, i) => `${i+1}. ${c.name}`).join('\n');
        const childIndex = prompt(`–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–±—ë–Ω–∫–∞:\n${childList}\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä:`) - 1;
        
        if (childIndex < 0 || childIndex >= children.length) return;
        
        const selectedChild = children[childIndex];
        const title = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:');
        if (!title) return;
        const description = prompt('–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):') || '';
        const reward = prompt('–ù–∞–≥—Ä–∞–¥–∞ (‚≠ê):');

        fetch(`${API_BASE}/api/tasks/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Invite-Code': currentCode },
          body: JSON.stringify({
            child_id: selectedChild.id,
            title,
            description,
            reward_amount: parseInt(reward),
            recurring: null,
            recurring_days: null
          })
        })
        .then(r => r.json())
        .then(data => {
          alert(data.message || '–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞!');
          loadAllMissions();
        })
        .catch(err => alert('–û—à–∏–±–∫–∞: ' + err.message));
      });
    }
  </script>
</body>
</html>
