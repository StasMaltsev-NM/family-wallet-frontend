#!/bin/bash
# –ü–∞—Ç—á –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ rewards –≤ worker.js

WORKER_FILE="worker.js"
BACKUP_FILE="worker.js.backup-$(date +%Y%m%d_%H%M%S)"

# –ë—ç–∫–∞–ø
cp "$WORKER_FILE" "$BACKUP_FILE"
echo "‚úÖ –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø: $BACKUP_FILE"

# –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É —Å "// 404" –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –ü–ï–†–ï–î –Ω–µ–π
awk '
/\/\/ 404/ {
  print ""
  print "      // ============================"
  print "      // REWARDS: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥–∞–º–∏"
  print "      // ============================"
  print ""
  print "      // POST /api/rewards/init ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã rewards (ADMIN)"
  print "      if (path === \"/api/rewards/init\" && request.method === \"POST\") {"
  print "        try {"
  print "          // –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É rewards"
  print "          await env.DB.prepare(`"
  print "            CREATE TABLE IF NOT EXISTS rewards ("
  print "              id TEXT PRIMARY KEY,"
  print "              family_id TEXT NOT NULL,"
  print "              title TEXT NOT NULL,"
  print "              description TEXT,"
  print "              price INTEGER NOT NULL CHECK (price >= 1 AND price <= 10000),"
  print "              icon TEXT DEFAULT \"üéÅ\","
  print "              is_permanent INTEGER DEFAULT 0 CHECK (is_permanent IN (0, 1)),"
  print "              is_active INTEGER DEFAULT 1 CHECK (is_active IN (0, 1)),"
  print "              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,"
  print "              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP"
  print "            )"
  print "          `).run();"
  print ""
  print "          // –°–æ–∑–¥–∞—ë–º –∏–Ω–¥–µ–∫—Å—ã"
  print "          await env.DB.prepare(`"
  print "            CREATE INDEX IF NOT EXISTS idx_rewards_family ON rewards(family_id)"
  print "          `).run();"
  print ""
  print "          await env.DB.prepare(`"
  print "            CREATE INDEX IF NOT EXISTS idx_rewards_active ON rewards(family_id, is_active)"
  print "          `).run();"
  print ""
  print "          return json({ message: \"–¢–∞–±–ª–∏—Ü–∞ rewards —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞\" });"
  print "        } catch (err) {"
  print "          return error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã: ${err.message}`, \"DB_ERROR\", 500);"
  print "        }"
  print "      }"
  print ""
  print "      // GET /api/rewards/list ‚Äî —Å–ø–∏—Å–æ–∫ –Ω–∞–≥—Ä–∞–¥ —Å–µ–º—å–∏"
  print "      if (path === \"/api/rewards/list\" && request.method === \"GET\") {"
  print "        const inviteCode = request.headers.get(\"X-Invite-Code\");"
  print "        "
  print "        if (!inviteCode) {"
  print "          return error(\"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ X-Invite-Code\", \"NO_AUTH\", 401);"
  print "        }"
  print ""
  print "        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—è"
  print "        const family = await env.DB.prepare("
  print "          \"SELECT id FROM families WHERE invite_code = ?\""
  print "        ).bind(inviteCode).first();"
  print ""
  print "        if (!family) {"
  print "          return error(\"–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–¥\", \"FORBIDDEN\", 403);"
  print "        }"
  print ""
  print "        // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞–≥—Ä–∞–¥"
  print "        const rewards = await env.DB.prepare(`"
  print "          SELECT id, family_id, title, description, price, icon, is_permanent, created_at, updated_at"
  print "          FROM rewards"
  print "          WHERE family_id = ? AND is_active = 1"
  print "          ORDER BY created_at DESC"
  print "        `).bind(family.id).all();"
  print ""
  print "        return json({ rewards: rewards.results || [] });"
  print "      }"
  print ""
  print "      // POST /api/rewards/create ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã (—Ç–æ–ª—å–∫–æ —Ä–æ–¥–∏—Ç–µ–ª—å)"
  print "      if (path === \"/api/rewards/create\" && request.method === \"POST\") {"
  print "        const inviteCode = request.headers.get(\"X-Invite-Code\");"
  print "        "
  print "        if (!inviteCode) {"
  print "          return error(\"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ X-Invite-Code\", \"NO_AUTH\", 401);"
  print "        }"
  print ""
  print "        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—è"
  print "        const family = await env.DB.prepare("
  print "          \"SELECT id FROM families WHERE invite_code = ?\""
  print "        ).bind(inviteCode).first();"
  print ""
  print "        if (!family) {"
  print "          return error(\"–¢–æ–ª—å–∫–æ —Ä–æ–¥–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—ã\", \"FORBIDDEN\", 403);"
  print "        }"
  print ""
  print "        // –ü–∞—Ä—Å–∏–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞"
  print "        const body = await request.json();"
  print "        const { title, description, price, icon, is_permanent } = body;"
  print ""
  print "        // –í–∞–ª–∏–¥–∞—Ü–∏—è"
  print "        if (!title || !price) {"
  print "          return error(\"–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: title, price\", \"INVALID_DATA\", 400);"
  print "        }"
  print ""
  print "        const priceInt = parseInt(price);"
  print "        if (isNaN(priceInt) || priceInt < 1 || priceInt > 10000) {"
  print "          return error(\"–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 1 –¥–æ 10000\", \"INVALID_DATA\", 400);"
  print "        }"
  print ""
  print "        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID"
  print "        const rewardId = `reward_${Date.now()}_${Math.random().toString(36).substring(2, 6)}`;"
  print ""
  print "        // –°–æ–∑–¥–∞—ë–º –Ω–∞–≥—Ä–∞–¥—É"
  print "        await env.DB.prepare(`"
  print "          INSERT INTO rewards (id, family_id, title, description, price, icon, is_permanent, is_active, created_at, updated_at)"
  print "          VALUES (?, ?, ?, ?, ?, ?, ?, 1, datetime(\"now\"), datetime(\"now\"))"
  print "        `).bind("
  print "          rewardId,"
  print "          family.id,"
  print "          title,"
  print "          description || \"\","
  print "          priceInt,"
  print "          icon || \"üéÅ\","
  print "          is_permanent ? 1 : 0"
  print "        ).run();"
  print ""
  print "        return json({"
  print "          message: \"–ù–∞–≥—Ä–∞–¥–∞ —Å–æ–∑–¥–∞–Ω–∞\","
  print "          reward: {"
  print "            id: rewardId,"
  print "            title,"
  print "            price: priceInt"
  print "          }"
  print "        });"
  print "      }"
  print ""
  print "      // DELETE /api/rewards/delete ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã (–º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ)"
  print "      if (path === \"/api/rewards/delete\" && request.method === \"DELETE\") {"
  print "        const inviteCode = request.headers.get(\"X-Invite-Code\");"
  print "        "
  print "        if (!inviteCode) {"
  print "          return error(\"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ X-Invite-Code\", \"NO_AUTH\", 401);"
  print "        }"
  print ""
  print "        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—è"
  print "        const family = await env.DB.prepare("
  print "          \"SELECT id FROM families WHERE invite_code = ?\""
  print "        ).bind(inviteCode).first();"
  print ""
  print "        if (!family) {"
  print "          return error(\"–¢–æ–ª—å–∫–æ —Ä–æ–¥–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –Ω–∞–≥—Ä–∞–¥—ã\", \"FORBIDDEN\", 403);"
  print "        }"
  print ""
  print "        // –ü–∞—Ä—Å–∏–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞"
  print "        const body = await request.json();"
  print "        const { reward_id } = body;"
  print ""
  print "        if (!reward_id) {"
  print "          return error(\"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç reward_id\", \"INVALID_DATA\", 400);"
  print "        }"
  print ""
  print "        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞–≥—Ä–∞–¥–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Å–µ–º—å–µ"
  print "        const reward = await env.DB.prepare("
  print "          \"SELECT id FROM rewards WHERE id = ? AND family_id = ?\""
  print "        ).bind(reward_id, family.id).first();"
  print ""
  print "        if (!reward) {"
  print "          return error(\"–ù–∞–≥—Ä–∞–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\", \"NOT_FOUND\", 404);"
  print "        }"
  print ""
  print "        // –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ"
  print "        await env.DB.prepare("
  print "          \"UPDATE rewards SET is_active = 0, updated_at = datetime('\'now\'') WHERE id = ?\""
  print "        ).bind(reward_id).run();"
  print ""
  print "        return json({ message: \"–ù–∞–≥—Ä–∞–¥–∞ —É–¥–∞–ª–µ–Ω–∞\" });"
  print "      }"
  print ""
}
{ print }
' "$WORKER_FILE" > "${WORKER_FILE}.tmp"

# –ó–∞–º–µ–Ω—è–µ–º —Ñ–∞–π–ª
mv "${WORKER_FILE}.tmp" "$WORKER_FILE"

echo "‚úÖ –ü–∞—Ç—á –ø—Ä–∏–º–µ–Ω—ë–Ω!"
echo "üìä –ù–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:"
wc -l "$WORKER_FILE"

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:"
grep -c "api/rewards" "$WORKER_FILE"
